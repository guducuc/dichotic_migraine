<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Dikotik & CI Çalışması — Final Tam Sürüm</title>

<meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
<meta name="emailjs-service" content="service_a8bnfmk">
<meta name="emailjs-template" content="template_r6sddff">

<style>
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:480px;margin:auto}
  h1{font-size:20px;margin-bottom:10px}
  .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px; background:#fff;}
  .hidden{display:none}
  input,select,textarea{padding:10px;margin:6px 0;width:100%;box-sizing:border-box; border:1px solid #ccc; border-radius:4px;}

  input[type="radio"], input[type="checkbox"] { width: auto; margin-right: 8px; transform: scale(1.1); }
  #participationOptions label, .question-group label { display: flex; align-items: center; margin-bottom: 8px; font-size: 14px; cursor:pointer; }

  .bigBtn{font-size:1.1rem;padding:12px 14px;border-radius:8px;border:1px solid #444;background:#eaeaea;cursor:pointer; width:100%; margin-top:8px;}
  .btnGreen{background:#2ecc71;color:white;border:none}
  .btnRed{background:#e74c3c;color:white;border:none}
  
  /* Yanıt Butonları */
  .respRow{ display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; padding: 0 5px; }
  .respRow.three-col { grid-template-columns: 1fr 1fr 1fr; } 
  
  .respBtn{ padding:15px; border-radius:8px; border:1px solid #444; background:#f2f2f2; cursor:pointer; text-align: center; font-weight:bold; font-size:14px; }
  .respBtn-active{background:#555 !important; color:#fff; border-color:#000;}

  .stai-options{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .stai-options label { margin-right: 15px; display: flex; align-items:center; }
  
  .hand-grid-header{display:flex;justify-content:space-between;margin-bottom:6px;font-weight:600}
  .hand-grid-row{display:flex;align-items:center;justify-content:space-between;border-top:1px solid #eee;padding:8px 0}
  .hand-grid-row span{flex:2}
  .hand-grid-row .col{flex:1;display:flex;justify-content:center;gap:10px}
  
  .small{font-size:13px;color:#666; line-height: 1.4;}
  .question-group{margin-bottom:20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px;}
  .question-title{font-weight: 700; font-size: 15px; margin-bottom: 8px; display: block;}
  
  #ciInfoDisplay { background:#f9f9f9; padding:15px; border:2px dashed #999; margin-bottom:15px; text-align:center; font-family:monospace; font-size:14px; color:#333; }

  .modal{position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none}
  .modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:10px;max-width:600px;max-height:80vh;overflow-y:auto}
  .close{float:right;font-size:28px;font-weight:bold;cursor:pointer;color:#888}
</style>
</head>
<body>
<h1>Dikotik & CI Çalışması</h1>

<div id="projectCard" class="card">
  <h3>Proje Kodu Seçimi</h3>
  <select id="projectCode">
    <option value="">Proje kodu seçiniz</option>
    <option value="OykuTez">Öykü Tez</option>
    <option value="Izmir">İzmir</option>
    <option value="Esporcu">Esporcu</option>
    <option value="Sporcu">Sporcu</option>
    <option value="OCM">OCM (Koku Duyusu)</option>
    <option value="CI">CI (Zamanlama Çalışması)</option>
  </select>
  <button id="toParticipationBtn" class="bigBtn">Devam</button>
</div>

<div id="participationCard" class="card hidden">
  <h3>Katılım Durumu</h3>
  <div id="participationOptions" class="small"></div>
  <button id="toNextStepBtn" class="bigBtn">Devam</button>
</div>

<div id="consentCard" class="card hidden">
  <h3>Aydınlatılmış Onam</h3>
  <div id="consentText" style="border:1px solid #ddd;padding:12px;border-radius:6px;max-height:250px;overflow:auto; background: #fff; font-size: 13px; line-height: 1.5;"></div>
  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="consentAccept" class="bigBtn btnGreen">Okudum, onaylıyorum</button>
    <button id="consentDecline" class="bigBtn btnRed">Kabul etmiyorum</button>
  </div>
  <div id="consentDeclinedMsg" class="small hidden" style="margin-top:10px;color:#c0392b; font-weight: bold;">Katılım kabul edilmedi.</div>
</div>

<div id="consentModal" class="modal">
  <div class="modal-content"><span id="closeConsentModal" class="close">&times;</span><div id="modalConsentBody" style="font-size:13px;line-height:1.4;"></div></div>
</div>

<div id="infoCard" class="card hidden">
  <h3>Katılımcı Bilgileri</h3>
  <div class="small">Ad ve soyad için ilk 2 harf yeterli (gizlilik).</div>
  <input id="name" placeholder="Ad (ilk 2 harf)">
  <input id="surname" placeholder="Soyad (ilk 2 harf)">
  <input id="age" type="number" placeholder="Yaş">
  <input id="email" type="email" placeholder="E-posta adresiniz">
  <input id="phone" type="tel" placeholder="Telefon numaranız">
  <input id="race" placeholder="Doğum yeri / Irk">
  <input id="motherTongue" placeholder="Anadiliniz">
  <select id="gender"><option value="">Cinsiyet</option><option>Kadın</option><option>Erkek</option><option>Diğer</option></select>
  <div id="codeInfo" class="small" style="margin-top:6px;color:#2c3e50"></div>
  <button id="toNextFromInfo" class="bigBtn">Devam</button>
</div>

<div id="esporcuFormCard" class="card hidden">
  <h3>Esporcu Bilgi Formu</h3>
  <div class="question-group"><span class="question-title">Eğitim Durumunuz *</span>
    <label><input type="radio" name="eduStatus" value="Ortaokul"> Ortaokul</label>
    <label><input type="radio" name="eduStatus" value="Lise"> Lise</label>
    <label><input type="radio" name="eduStatus" value="Üniversite"> Üniversite</label>
    <label><input type="radio" name="eduStatus" value="Yüksek Lisans"> Yüksek Lisans</label>
    <label><input type="radio" name="eduStatus" value="Doktora"> Doktora</label>
  </div>
  <div class="question-group"><span class="question-title">Kaç yıldır oyun oynuyorsunuz? *</span><input id="playYears" type="number" placeholder="Yanıtınız"></div>
  <div class="question-group"><span class="question-title">Günde kaç saat oyun oynuyorsunuz? *</span><input id="dailyHours" type="number" placeholder="Yanıtınız"></div>
  <div class="question-group"><span class="question-title">Oyun oynadığınız platform *</span>
    <label><input type="radio" name="platform" value="Bilgisayar"> Bilgisayar</label>
    <label><input type="radio" name="platform" value="Mobil"> Mobil</label>
    <label><input type="radio" name="platform" value="Playstation"> Playstation</label>
    <label><input type="radio" name="platform" value="Diğer"> Diğer</label>
  </div>
  <div class="question-group"><span class="question-title">Oyun türü *</span>
    <label><input type="radio" name="gameType" value="FPS"> FPS</label>
    <label><input type="radio" name="gameType" value="SPOR"> SPOR</label>
    <label><input type="radio" name="gameType" value="MMORPG"> MMORPG</label>
    <label><input type="radio" name="gameType" value="MOBA"> MOBA</label>
    <label><input type="radio" name="gameType" value="RPG"> RPG</label>
    <label><input type="radio" name="gameType" value="RTS"> RTS</label>
    <label><input type="radio" name="gameType" value="Diğer"> Diğer</label>
  </div>
  <div class="question-group"><span class="question-title">Oyun adı *</span><input id="topGameName" placeholder="Yanıtınız"></div>
  <div class="question-group"><span class="question-title">En Yüksek Rütbe *</span><input id="topRank" placeholder="Yanıtınız"></div>
  <button id="toHandFromEsporcu" class="bigBtn">Devam</button>
</div>

<div id="sporcuFormCard" class="card hidden">
  <h3>Sporcu Bilgi Formu</h3>
  <div class="question-group"><span class="question-title">Eğitim Durumunuz *</span>
    <label><input type="radio" name="eduStatusSporcu" value="Ortaokul"> Ortaokul</label>
    <label><input type="radio" name="eduStatusSporcu" value="Lise"> Lise</label>
    <label><input type="radio" name="eduStatusSporcu" value="Üniversite"> Üniversite</label>
    <label><input type="radio" name="eduStatusSporcu" value="Yüksek Lisans"> Yüksek Lisans</label>
    <label><input type="radio" name="eduStatusSporcu" value="Doktora"> Doktora</label>
  </div>
  <div class="question-group"><span class="question-title">Kaç yıldır spor yapmaktasınız? *</span><input id="sportYears" type="number" placeholder="Yıl"></div>
  <div class="question-group"><span class="question-title">Lisanslı olarak kaç yıldır basketbol oynamaktasınız? *</span><input id="basketballYears" type="number" placeholder="Yıl"></div>
  <div class="question-group"><span class="question-title">Pozisyon *</span>
    <label><input type="radio" name="position" value="Guard"> Guard</label>
    <label><input type="radio" name="position" value="Forvet"> Forvet</label>
    <label><input type="radio" name="position" value="Pivot"> Pivot</label>
  </div>
  <button id="toHandFromSporcu" class="bigBtn">Devam</button>
</div>
<div id="enterCodeCard" class="card hidden">
  <h3>Önceki Katılımcı Kodu</h3>
  <input id="previousCode" placeholder="OY_AB_12345">
  <button id="toStaiDirectBtn" class="bigBtn">Devam</button>
</div>

<div id="handUseCard" class="card hidden">
  <h3>El Kullanımı Testi</h3>
  <p class="small">Sağ veya sol elinizi hangi işlemlerde kullandığınızı bilmek istiyoruz. Lütfen her işlemde kullandığınız ele göre ‘sol’ veya ‘sağ’ hanesini işaretleyin. Mesela yazı yazarken, genellikle sağ ama ara sıra sol elinizi kullanıyorsanız, her iki elin altında yalnızca birer kutucuğu tıklayın. Daima sağ elinizi kullanıyorsanız, sağ el altındaki iki kutucuğu da işaretleyin. Diğer soruları aynı şekilde cevaplandırın. Her satırda mutlaka iki işaretleme olmalıdır.</p>
  <div id="handUseQuestions"></div>
  <button id="toStaiBtn" class="bigBtn">Devam</button>
</div>

<div id="staiCard" class="card hidden">
  <h3>STAI-TXI Formu</h3>
  <p class="small">Aşağıda kişilerin kendilerine ait duygularını anlatmada kullandıkları bir takım ifadeler verilmiştir. Her ifadeyi okuyun, sonra da nasıl hissettiğinizi ifadelerin sağ tarafındaki parantezlerden uygun olanını karalamak suretiyle belirtin. Doğru ya da yanlış cevap yoktur. Herhangi bir ifadenin üzerinde fazla zaman sarf etmeksizin anında nasıl hissettiğinizi gösteren cevabı işaretleyin.</p>
  <div id="staiQuestions"></div>
  <button id="toHearingBtn" class="bigBtn">Devam</button>
</div>

<div id="hearingCard" class="card hidden">
  <h3>İşitme Kontrolü</h3>
  <p class="small" style="color:#c0392b"><b>ÖNEMLİ (iPhone/iPad):</b> Telefonun yanındaki "Sessiz" tuşunu kapatın (zil sesi açık olmalı), aksi takdirde ses duyulmayabilir.</p>
  <div style="margin-top:8px">
    <label><b>Sol Kulak</b></label>
    <input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5"><button id="playLeft" class="bigBtn">Sol Oynat</button>
  </div>
  <div style="margin-top:12px">
    <label><b>Sağ Kulak</b></label>
    <input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5"><button id="playRight" class="bigBtn">Sağ Oynat</button>
  </div>
  <button id="toSessionIntro" class="bigBtn">Devam</button>
</div>

<div id="ciCard" class="card hidden">
  <h3>CI - İşitsel Zamanlama Testi</h3>
  <div id="ciInfoDisplay">Hazırlanıyor...</div>
  <p class="small" style="text-align:center; margin-bottom:10px;">Sesi hangi yönden duydunuz?</p>
  <div class="respRow three-col">
    <button class="respBtn ciRespBtn" data-ans="Left">SOL</button>
    <button class="respBtn ciRespBtn" data-ans="Equal">ORTA / EŞİT</button>
    <button class="respBtn ciRespBtn" data-ans="Right">SAĞ</button>
  </div>
</div>

<div id="sessionIntro" class="card hidden">
  <h3 id="sessionTitle"></h3>
  <p id="sessionInstr"></p>
  <button id="sessionStartBtn" class="bigBtn">Başla</button>
</div>

<div id="trialCard" class="card hidden">
  <div id="trialStatus" class="small" style="margin-bottom:8px"></div>
  <audio id="stimAudio" preload="auto" playsinline></audio>
  <div class="respRow">
    <button class="respBtn dicoticRespBtn" data-val="BA">BA</button><button class="respBtn dicoticRespBtn" data-val="DA">DA</button>
    <button class="respBtn dicoticRespBtn" data-val="GA">GA</button><button class="respBtn dicoticRespBtn" data-val="KA">KA</button>
    <button class="respBtn dicoticRespBtn" data-val="PA">PA</button><button class="respBtn dicoticRespBtn" data-val="TA">TA</button>
  </div>
</div>

<div id="endCard" class="card hidden"><h3>Deney tamamlandı ✅</h3><div id="doneLog" class="small"></div></div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

const $id = id => document.getElementById(id);
function shuffle(arr){ 
  for(let i=arr.length-1;i>0;i--){ 
    const j=Math.floor(Math.random()*(i+1)); 
    [arr[i],arr[j]]=[arr[j],arr[i]]; 
  } 
  return arr; 
}

/* GLOBAL DEĞİŞKENLER */
let participant = {}, results = [], sessionOrder = [], currentSessionIndex = 0, currentTrial = -1;
let audioCtx=null, leftOsc=null, rightOsc=null;
let isResponseAllowed=false, trialTimeout=null, responseStart=0;

/* CI Değişkenleri */
let ciStimuli = [], ciCurrentIndex = 0;
const ciSpeechFiles = ["LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav"];
const ciDelays = [0, 0.003, 0.006, 0.009];

/* iOS UNLOCKER (Buffer Tekniği) */
function unlockAudio() {
  if (!audioCtx) { 
    const AudioContext = window.AudioContext || window.webkitAudioContext; 
    audioCtx = new AudioContext(); 
  }
  if (audioCtx.state === 'suspended') { audioCtx.resume(); }
  
  const buffer = audioCtx.createBuffer(1, 1, 22050);
  const source = audioCtx.createBufferSource();
  source.buffer = buffer;
  source.connect(audioCtx.destination);
  source.start(0);
}
document.body.addEventListener('click', unlockAudio, {once:true});
document.body.addEventListener('touchstart', unlockAudio, {once:true});

/* ONAM METİNLERİ */
const CONSENT_TEXTS = {
  "Sport": `<p><b>Sorumlu:</b> Dr. Öğr. Üyesi Emre Eskicioğlu</p><p>Sporcu ve Esporcu çalışması.</p>`,
  "OCM": `<p><b>Sorumlu:</b> Emre Eskicioğlu</p><p>Koku duyusu çalışması.</p>`,
  "CI": `<h3>CI (Zamanlama) Çalışması</h3><p>Bu çalışmada seslerin sağ ve sol kulağa farklı zamanlarda ulaşması test edilecektir. Bip sesleri ve heceler kullanılacaktır.</p>`,
  "Default": `<p>İşitsel algı çalışması.</p>`
};

/* STAI SORULARI - GÜVENLİK GEREĞİ BOŞ BIRAKILDI, SİZ DOLDURUNUZ */
const staiQuestions = []; 

/* ---------------- FLOW MANTIĞI ---------------- */
$id('toParticipationBtn').onclick = ()=>{
  const proj = $id('projectCode').value;
  if(!proj){ alert('Seçiniz.'); return; }
  participant.projectCode = proj;
  $id('projectCard').classList.add('hidden'); $id('participationCard').classList.remove('hidden');
  renderParticipationOptions(proj);
};

function renderParticipationOptions(project){
  const el = $id('participationOptions'); el.innerHTML = '';
  const needsSecond = (project === 'OykuTez' || project === 'OCM');
  el.innerHTML = `<label><input type="radio" name="participation" value="1"> İlk kez katılıyorum</label>
    <label><input type="radio" name="participation" value="2"> Bir kez katıldım ama tamamlayamadım</label>` +
    (needsSecond ? `<label><input type="radio" name="participation" value="3"> İkinci kez katılıyorum</label>` : '');
}

$id('toNextStepBtn').onclick = ()=>{
  const sel = document.querySelector('input[name="participation"]:checked');
  if(!sel){ alert('Seçiniz.'); return; }
  participant.participation = sel.value;
  $id('participationCard').classList.add('hidden');
  if(sel.value === '1'){
    const txt = CONSENT_TEXTS[participant.projectCode] || CONSENT_TEXTS["Default"];
    $id('consentText').innerHTML = txt; $id('modalConsentBody').innerHTML = txt;
    $id('consentCard').classList.remove('hidden');
  } else { $id('enterCodeCard').classList.remove('hidden'); }
};

$id('consentAccept').onclick = ()=>{ $id('consentCard').classList.add('hidden'); $id('infoCard').classList.remove('hidden'); };
$id('consentDecline').onclick = ()=>{ $id('consentDeclinedMsg').classList.remove('hidden'); $id('consentAccept').disabled = true; };
$id('openConsentPopup').onclick=()=>{ $id('consentModal').style.display='block'; };
$id('closeConsentModal').onclick=()=>{ $id('consentModal').style.display='none'; };

$id('toNextFromInfo').onclick = ()=>{
  const n = $id('name').value.trim(), s = $id('surname').value.trim(), a = $id('age').value.trim();
  if(!n || !s || !a){ alert('Eksik bilgi.'); return; }
  participant.name = n.slice(0,2); participant.surname = s.slice(0,2); participant.age = a;
  participant.email = $id('email').value; participant.phone = $id('phone').value;
  participant.race = $id('race').value; participant.motherTongue = $id('motherTongue').value; participant.gender = $id('gender').value;
  
  participant.code = participant.projectCode + '_' + (n+s).toUpperCase().slice(0,4).padEnd(4,'X') + '_' + Math.floor(10000+Math.random()*90000);
  $id('codeInfo').innerText = 'Kod: ' + participant.code;
  $id('infoCard').classList.add('hidden');

  if(participant.projectCode === 'Esporcu') $id('esporcuFormCard').classList.remove('hidden');
  else if(participant.projectCode === 'Sporcu') $id('sporcuFormCard').classList.remove('hidden');
  else { renderHand(); $id('handUseCard').classList.remove('hidden'); }
};

$id('toHandFromEsporcu').onclick = ()=>{
  const edu = document.querySelector('input[name="eduStatus"]:checked');
  const plat = document.querySelector('input[name="platform"]:checked');
  const type = document.querySelector('input[name="gameType"]:checked');
  const years = $id('playYears').value;
  const hours = $id('dailyHours').value;
  const game = $id('topGameName').value;
  const rank = $id('topRank').value;
  if(!edu || !plat || !type || !years || !hours || !game || !rank){ alert('Eksik bilgi.'); return; }
  participant.esporData = { education: edu.value, platform: plat.value, genre: type.value, yearsPlaying: years, dailyHours: hours, topGame: game, highestRank: rank };
  $id('esporcuFormCard').classList.add('hidden'); renderHand(); $id('handUseCard').classList.remove('hidden');
};

$id('toHandFromSporcu').onclick = ()=>{
  const edu = document.querySelector('input[name="eduStatusSporcu"]:checked');
  const years = $id('sportYears').value;
  const bYears = $id('basketballYears').value;
  const pos = document.querySelector('input[name="position"]:checked');
  if(!edu || !years || !bYears || !pos){ alert('Eksik bilgi.'); return; }
  participant.sporcuData = { education: edu.value, sportYears: years, basketballYears: bYears, position: pos.value };
  $id('sporcuFormCard').classList.add('hidden'); renderHand(); $id('handUseCard').classList.remove('hidden');
};

function renderHand(){
  const c = $id('handUseQuestions'); c.innerHTML = '<div class="hand-grid-header"><span></span><div class="col">Sol</div><div class="col">Sağ</div></div>';
  ["Yazmak","Çizmek","Taş Atmak","Makas kullanmak","Diş fırçası kullanmak","Bıçak kullanmak","Kaşık kullanmak","Süpürge (üst el)","Kibrit çakmak","Kutunun kapağını açmak"].forEach((q,i)=>{
    c.innerHTML += `<div class="hand-grid-row"><span>${q}</span><div class="col"><input type="checkbox" class="left"><input type="checkbox" class="left"></div><div class="col"><input type="checkbox" class="right"><input type="checkbox" class="right"></div></div>`;
  });
}

$id('toStaiBtn').onclick = ()=>{
  const rows = document.querySelectorAll('#handUseQuestions .hand-grid-row');
  for(const r of rows) if(r.querySelectorAll('input:checked').length !== 2){ alert('Her satıra 2 işaret!'); return; }
  participant.handUse = Array.from(rows).map((r,i)=>({q:i+1, left:r.querySelectorAll('.left:checked').length, right:r.querySelectorAll('.right:checked').length}));
  $id('handUseCard').classList.add('hidden'); renderStai(); $id('staiCard').classList.remove('hidden');
};

function renderStai(){
  const c = $id('staiQuestions'); c.innerHTML = '';
  staiQuestions.forEach((q,i)=>{
    c.innerHTML += `<div class="question-group"><p>${i+1}. ${q}</p>
      <div class="stai-options"><label><input type="radio" name="staiQ${i+1}" value="1">Hiç</label><label><input type="radio" name="staiQ${i+1}" value="2">Biraz</label><label><input type="radio" name="staiQ${i+1}" value="3">Çok</label><label><input type="radio" name="staiQ${i+1}" value="4">Tamamıyla</label></div></div>`;
  });
}

$id('toHearingBtn').onclick = ()=>{
  if(document.querySelectorAll('#staiQuestions input:checked').length < staiQuestions.length){ alert('Tüm soruları yanıtlayın.'); return; }
  participant.staiAnswers = {};
  document.querySelectorAll('#staiQuestions input:checked').forEach(i=> participant.staiAnswers[i.name]=i.value);
  $id('staiCard').classList.add('hidden'); $id('hearingCard').classList.remove('hidden');
};
  /* --- SES MOTORU (Safari Fix + Stereo Pan) --- */
function ensureCtx(){ 
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
  if(audioCtx.state==='suspended') audioCtx.resume(); 
}
function stopL(){ try{if(leftOsc)leftOsc.stop()}catch(e){} leftOsc=null; }
function stopR(){ try{if(rightOsc)rightOsc.stop()}catch(e){} rightOsc=null; }

// Bip sesleri çok gürültülü olduğu için %20 seviyesine indiriyoruz
const TONE_GAIN_FACTOR = 0.2; 

async function startL(){
  ensureCtx(); stopR(); stopL();
  leftOsc = audioCtx.createOscillator(); leftOsc.frequency.value = 1500;
  const gain = audioCtx.createGain(); gain.gain.value = Number($id('leftSlider').value) * TONE_GAIN_FACTOR;
  
  if(audioCtx.createStereoPanner){ 
    const p=audioCtx.createStereoPanner(); p.pan.value=-1; 
    leftOsc.connect(gain).connect(p).connect(audioCtx.destination); 
  } else { 
    const p=audioCtx.createPanner(); p.setPosition(-1,0,0); 
    leftOsc.connect(gain).connect(p).connect(audioCtx.destination); 
  }
  leftOsc.start(); setTimeout(stopL, 1200);
}

async function startR(){
  ensureCtx(); stopL(); stopR();
  rightOsc = audioCtx.createOscillator(); rightOsc.frequency.value = 1500;
  const gain = audioCtx.createGain(); gain.gain.value = Number($id('rightSlider').value) * TONE_GAIN_FACTOR;
  
  if(audioCtx.createStereoPanner){ 
    const p=audioCtx.createStereoPanner(); p.pan.value=1; 
    rightOsc.connect(gain).connect(p).connect(audioCtx.destination); 
  } else { 
    const p=audioCtx.createPanner(); p.setPosition(1,0,0); 
    rightOsc.connect(gain).connect(p).connect(audioCtx.destination); 
  }
  rightOsc.start(); setTimeout(stopR, 1200);
}

$id('playLeft').onclick = startL; 
$id('playRight').onclick = startR;

$id('toSessionIntro').onclick = ()=>{
  stopL(); stopR();
  participant.leftLevel = $id('leftSlider').value; 
  participant.rightLevel = $id('rightSlider').value;
  results.push({ session: 'hearing_level', trial: 0, stim: '1500Hz', response: '', responseTime: '', leftLevel: participant.leftLevel, rightLevel: participant.rightLevel });
  
  $id('hearingCard').classList.add('hidden');
  
  // YENİ: CI Projesi Kontrolü
  if (participant.projectCode === 'CI') {
    initCITest(); 
  } else { 
    sessionOrder=['training','NF', ...shuffle(['FR','FL'])]; 
    showSessionIntro(); 
  }
};

/* --- CI TEST LOGIC (GÜNCELLENMİŞ VERSİYON) --- */
function initCITest() {
  ciStimuli = [];
  
  // Grup 1: Bip Sesleri (Tone) - Sırayla ekle ve karıştır
  let toneStims = [];
  ciDelays.forEach(d => { 
    toneStims.push({type:'tone', file:'Tone 1500Hz', delay:d, leading:'Left'}); 
    if(d>0) toneStims.push({type:'tone', file:'Tone 1500Hz', delay:d, leading:'Right'}); 
  });
  toneStims = shuffle(toneStims);

  // Grup 2: Hece Sesleri (Speech) - Sırayla ekle ve karıştır
  let speechStims = [];
  ciSpeechFiles.forEach(f => { 
    ciDelays.forEach(d => { 
      speechStims.push({type:'speech', file:f, delay:d, leading:'Left'}); 
      if(d>0) speechStims.push({type:'speech', file:f, delay:d, leading:'Right'}); 
    }); 
  });
  speechStims = shuffle(speechStims);

  // Önce Tone grubunu, bitince Speech grubunu çal
  ciStimuli = [...toneStims, ...speechStims];
  ciCurrentIndex = 0;
  
  $id('ciCard').classList.remove('hidden');
  setTimeout(playCINext, 1000); // 1 sn sonra başlat
}

async function playCINext() {
  if (ciCurrentIndex >= ciStimuli.length) { 
    endExperiment(); 
    return; 
  }
  
  isResponseAllowed = false;
  const stim = ciStimuli[ciCurrentIndex];
  
  // Kullanıcıya bilgi göster
  $id('ciInfoDisplay').innerHTML = `Uyaran: ${stim.type==='tone'?'BİP (Tone)':'HECE (Speech)'} <br> ${ciCurrentIndex+1} / ${ciStimuli.length}`;

  if (stim.type === 'tone') {
    playToneITD(stim.delay, stim.leading);
  } else {
    await playSpeechITD(stim.file, stim.delay, stim.leading);
  }

  responseStart = Date.now();
  
  // Yanıt butonlarını hazırla (Rengi sıfırla)
  document.querySelectorAll('.ciRespBtn').forEach(b => b.classList.remove('respBtn-active'));
  
  // Ses çaldıktan 200ms sonra basmaya izin ver
  setTimeout(()=> isResponseAllowed = true, 200);
}

// CI Yanıt Butonları
document.querySelectorAll('.ciRespBtn').forEach(btn => {
  btn.onclick = () => {
    if(!isResponseAllowed) return;
    isResponseAllowed = false;
    
    const rt = Date.now() - responseStart;
    const stim = ciStimuli[ciCurrentIndex];
    
    // Sonucu kaydet
    results.push({ 
      session: 'CI_ITD', 
      trial: ciCurrentIndex+1, 
      stim: stim.file, 
      type: stim.type, 
      delay: stim.delay, 
      leading: stim.leading, 
      response: btn.dataset.ans, 
      responseTime: rt 
    });
    
    // Görsel efekt: Seçilen butonu koyulaştır
    btn.classList.add('respBtn-active');
    
    // 500ms sonra rengi eski haline getir
    setTimeout(() => btn.classList.remove('respBtn-active'), 500);
    
    // 2 saniye bekle ve sonraki soruya geç
    setTimeout(() => {
        ciCurrentIndex++;
        playCINext();
    }, 2000);
  };
});

function playToneITD(delay, leading) {
  ensureCtx();
  const oscL = audioCtx.createOscillator(); oscL.frequency.value = 1500;
  const oscR = audioCtx.createOscillator(); oscR.frequency.value = 1500;
  const gL = audioCtx.createGain(); gL.gain.value = Number($id('leftSlider').value) * TONE_GAIN_FACTOR;
  const gR = audioCtx.createGain(); gR.gain.value = Number($id('rightSlider').value) * TONE_GAIN_FACTOR;

  // Panner Setup
  const pL = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : audioCtx.createPanner();
  if(pL.pan) pL.pan.value=-1; else pL.setPosition(-1,0,0);
  
  const pR = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : audioCtx.createPanner();
  if(pR.pan) pR.pan.value=1; else pR.setPosition(1,0,0);

  oscL.connect(gL).connect(pL).connect(audioCtx.destination);
  oscR.connect(gR).connect(pR).connect(audioCtx.destination);

  // Gecikme Hesapla
  const now = audioCtx.currentTime + 0.1;
  let tL = now, tR = now;
  if(leading==='Left') tR += delay; else if(leading==='Right') tL += delay;
  
  oscL.start(tL); oscL.stop(tL+0.5); // 500ms çal
  oscR.start(tR); oscR.stop(tR+0.5);
}

async function playSpeechITD(file, delay, leading) {
  ensureCtx();
  const path = './sounds/yeni/erkek/' + file;
  try {
    const res = await fetch(path);
    const buf = await audioCtx.decodeAudioData(await res.arrayBuffer());
    
    const srcL = audioCtx.createBufferSource();
    const srcR = audioCtx.createBufferSource();
    
    // Mono Kanallara Ayır
    const bL = audioCtx.createBuffer(1, buf.length, buf.sampleRate); bL.copyToChannel(buf.getChannelData(0),0);
    const bR = audioCtx.createBuffer(1, buf.length, buf.sampleRate); bR.copyToChannel(buf.getChannelData(1),0);
    
    srcL.buffer = bL; 
    srcR.buffer = bR;

    const gL = audioCtx.createGain(); gL.gain.value = Number($id('leftSlider').value); // Speech %100 gain
    const gR = audioCtx.createGain(); gR.gain.value = Number($id('rightSlider').value);

    const pL = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : audioCtx.createPanner();
    if(pL.pan) pL.pan.value=-1; else pL.setPosition(-1,0,0);
    const pR = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : audioCtx.createPanner();
    if(pR.pan) pR.pan.value=1; else pR.setPosition(1,0,0);

    srcL.connect(gL).connect(pL).connect(audioCtx.destination);
    srcR.connect(gR).connect(pR).connect(audioCtx.destination);

    const now = audioCtx.currentTime + 0.1;
    let tL = now, tR = now;
    if(leading==='Left') tR += delay; else if(leading==='Right') tL += delay;

    srcL.start(tL); srcR.start(tR);
  } catch(e){ 
    console.error(e); 
    // Hata olursa pas geç
    setTimeout(() => { ciCurrentIndex++; playCINext(); }, 100); 
  }
}

/* STANDART DİKOTİK LOOP */
const trainingPlaylist = ["LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav","LBA-RDA.wav","LDA-RGA.wav","LGA-RKA.wav","LKA-RTA.wav"];
const mainPlaylist = ["LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav","LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav","LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav","LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav","LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav","LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav","LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav","LPA-RGA.wav"];

function showSessionIntro(){
  const s = sessionOrder[currentSessionIndex];
  $id('sessionTitle').innerText = 'Oturum: ' + s;
  const i = {training:'Eğitim: Sadece dinleyin.', NF:'En iyi duyduğunuzu seçin.', FR:'SAĞ kulağa odaklanın.', FL:'SOL kulağa odaklanın.'};
  $id('sessionInstr').innerText = i[s]; 
  $id('sessionIntro').classList.remove('hidden');
}

$id('sessionStartBtn').onclick = async ()=>{
  $id('sessionIntro').classList.add('hidden'); 
  ensureCtx();
  try{ const a = $id('stimAudio'); a.src=''; await a.play().catch(()=>{}); }catch(e){}
  setTimeout(()=> { currentTrial = -1; $id('trialCard').classList.remove('hidden'); nextTrial(); }, 200);
};

function nextTrial(){
  clearTimeout(trialTimeout);
  const list = (sessionOrder[currentSessionIndex]==='training') ? trainingPlaylist : mainPlaylist;
  currentTrial++;
  if(currentTrial >= list.length){ 
    $id('trialCard').classList.add('hidden'); 
    currentSessionIndex++; 
    if(currentSessionIndex < sessionOrder.length) showSessionIntro(); 
    else endExperiment(); 
    return; 
  }
  playStim(list[currentTrial]);
}

async function playStim(stim){
  isResponseAllowed = false; 
  $id('stimAudio').src = './sounds/yeni/erkek/' + stim;
  try { 
    await $id('stimAudio').play(); 
    responseStart = Date.now(); 
    setTimeout(()=>isResponseAllowed=true, 500); 
    trialTimeout=setTimeout(()=>{
        if(sessionOrder[currentSessionIndex]!=='training') saveTrial(stim,'no_response',4000); 
        nextTrial();
    }, 4000); 
  } catch(e){ nextTrial(); }
}

function saveTrial(stim, resp, rt){ 
    results.push({session: sessionOrder[currentSessionIndex], trial: currentTrial+1, stim, response: resp, responseTime: rt, code: participant.code}); 
}

document.querySelectorAll('.dicoticRespBtn').forEach(btn=>{
  btn.onclick = ()=>{
    if(!isResponseAllowed) return; 
    isResponseAllowed = false; 
    clearTimeout(trialTimeout);
    
    if(sessionOrder[currentSessionIndex]!=='training') {
        saveTrial((sessionOrder[currentSessionIndex]==='training'?trainingPlaylist:mainPlaylist)[currentTrial], btn.dataset.val, Date.now()-responseStart);
    }
    
    btn.classList.add('respBtn-active'); 
    setTimeout(()=>{btn.classList.remove('respBtn-active')}, 300); 
    setTimeout(nextTrial, 2500);
  };
});

/* E-POSTA YAPILANDIRMASI */
const EMAIL_CONFIG = { 
    "Esporcu": { service: "service_a8bnfmk", template: "template_r6sddff" }, 
    "OCM":     { service: "service_a8bnfmk", template: "template_r6sddff" }, 
    "CI":      { service: "service_a8bnfmk", template: "template_r6sddff" }, 
    "DEFAULT": { service: "service_a8bnfmk", template: "template_r6sddff" } 
};

function makeCsv(){
  let csv = 'CODE,PROJECT,AGE,GENDER,EMAIL,PHONE,LANG,LEFT_LVL,RIGHT_LVL\n';
  csv += `${participant.code},${participant.projectCode},${participant.age},${participant.gender},${participant.email},${participant.phone},${participant.motherTongue},${participant.leftLevel},${participant.rightLevel}\n\n`;
  if(participant.esporData) csv += 'ESPOR DATA\n'+JSON.stringify(participant.esporData)+'\n\n';
  if(participant.sporcuData) csv += 'SPORCU DATA\n'+JSON.stringify(participant.sporcuData)+'\n\n';
  
  if(participant.projectCode==='CI'){
    csv += 'TYPE,STIMULUS,DELAY,LEADING,RESPONSE,RT\n';
    results.forEach(r=>{ csv += `${r.type},${r.stim},${r.delay},${r.leading},${r.response},${r.responseTime}\n`; });
  } else {
    csv += 'SESSION,TRIAL,STIMULUS,RESPONSE,RT\n';
    results.forEach(r=>{ csv += `${r.session},${r.trial},${r.stim},${r.response},${r.responseTime}\n`; });
  }
  return csv;
}

async function sendEmail(){
  const csv = makeCsv();
  const config = EMAIL_CONFIG[participant.projectCode] || EMAIL_CONFIG["DEFAULT"];
  try{
    if(!window.emailjs){ 
        const s=document.createElement('script'); 
        s.src='https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js'; 
        await new Promise(res=>{s.onload=res;document.head.appendChild(s)}); 
    }
    emailjs.init($id('emailjs-user').content);
    await emailjs.send(config.service, config.template, { subject: participant.code, message: csv });
    $id('doneLog').innerText = 'Veriler başarıyla gönderildi.';
  }catch(e){ $id('doneLog').innerText = 'E-posta hatası: '+e; }
}

async function endExperiment(){ 
    $id('trialCard').classList.add('hidden'); 
    $id('ciCard').classList.add('hidden'); 
    $id('endCard').classList.remove('hidden'); 
    await sendEmail(); 
}

});
</script>
</body>
</html>
