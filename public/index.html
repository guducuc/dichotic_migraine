<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Dikotik & CI Testi ‚Äî Final Fix</title>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; margin:0; padding:15px; background:#f4f4f4; color:#333; padding-bottom: 150px;} 
  h1{font-size:1.4rem; text-align:center; margin-bottom:15px;}
  .card{background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:20px; margin-bottom:15px;}
  .hidden{display:none !important;}
  
  input, select { width:100%; padding:12px; margin:8px 0; border:1px solid #ccc; border-radius:8px; font-size:16px; box-sizing:border-box; }
  
  .bigBtn { width:100%; padding:15px; border:none; border-radius:8px; background:#007AFF; color:white; font-size:16px; font-weight:bold; cursor:pointer; margin-top:10px; -webkit-appearance: none; }
  .bigBtn:active { background:#0056b3; transform:scale(0.98); }
  .btnGreen { background:#34C759; }
  
  /* CI Butonlarƒ± */
  .respRow { display:flex; gap:10px; margin-top:15px; }
  .respBtn { flex:1; padding:15px; background:#E5E5EA; border-radius:8px; text-align:center; font-weight:bold; cursor:pointer; border:1px solid #d1d1d6; user-select: none; }
  
  /* Debug Konsolu */
  #debugConsole { position:fixed; bottom:0; left:0; width:100%; height:100px; background:#000; color:#0f0; font-family:monospace; font-size:11px; padding:10px; overflow-y:scroll; z-index:9999; border-top:2px solid #333; display:block; }
  
  #loadingOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:2000; display:flex; justify-content:center; align-items:center; flex-direction:column; }
</style>
</head>
<body>

<h1>Dikotik & CI √áalƒ±≈ümasƒ±</h1>

<div id="debugConsole">Sistem Hazƒ±r...</div>

<div id="loadingOverlay" class="hidden">
  <div style="font-size:20px; font-weight:bold; margin-bottom:10px;">Sesler Y√ºkleniyor</div>
  <div id="loadingText">%0</div>
</div>

<div id="card_project" class="card">
  <h3>Proje Se√ßimi</h3>
  <select id="projectCode">
    <option value="">Se√ßiniz...</option>
    <option value="CI">CI (Zamanlama)</option>
    <option value="Esporcu">Esporcu</option>
    <option value="Sporcu">Sporcu</option>
    <option value="OCM">OCM</option>
    <option value="OykuTez">√ñyk√º Tez</option>
  </select>
  <button class="bigBtn" onclick="window.nextStep('card_participation')">Devam</button>
</div>

<div id="card_participation" class="card hidden">
  <h3>Katƒ±lƒ±m Durumu</h3>
  <label style="display:block; margin:10px 0;"><input type="radio" name="partType" value="1" checked> ƒ∞lk kez katƒ±lƒ±yorum</label>
  <label style="display:block; margin:10px 0;"><input type="radio" name="partType" value="2"> Daha √∂nce katƒ±ldƒ±m</label>
  <button class="bigBtn" onclick="window.nextStep('card_consent')">Devam</button>
</div>

<div id="card_consent" class="card hidden">
  <h3>Onam Formu</h3>
  <div style="height:100px; overflow-y:scroll; border:1px solid #ddd; padding:10px; font-size:13px; margin-bottom:10px;">
    Bu √ßalƒ±≈üma bilimsel ama√ßlƒ±dƒ±r. Verileriniz anonim kalacaktƒ±r.
  </div>
  <button class="bigBtn btnGreen" onclick="window.nextStep('card_info')">Kabul Ediyorum</button>
</div>

<div id="card_info" class="card hidden">
  <h3>Ki≈üisel Bilgiler</h3>
  <input id="inp_name" placeholder="Ad (ƒ∞lk 2 harf)">
  <input id="inp_surname" placeholder="Soyad (ƒ∞lk 2 harf)">
  <input id="inp_age" type="number" placeholder="Ya≈ü">
  <input id="inp_email" type="email" placeholder="E-posta">
  <button class="bigBtn" onclick="window.saveInfo()">Devam</button>
</div>

<div id="card_hearing" class="card hidden">
  <h3>Ses Kontrol√º</h3>
  <p style="color:red; font-size:13px; font-weight:bold;">‚ö†Ô∏è iPhone: "Sessiz" tu≈üunu kapatƒ±n!</p>
  
  <div style="background:#eee; padding:10px; border-radius:8px; margin-bottom:10px;">
    <label>Sol Ses</label> <input type="range" id="vol_L" min="0" max="1" step="0.1" value="0.5">
    <button class="bigBtn" style="margin-top:5px; background:#5856d6;" onclick="window.playTestTone(-1)">Sol Test üîä</button>
  </div>

  <div style="background:#eee; padding:10px; border-radius:8px;">
    <label>Saƒü Ses</label> <input type="range" id="vol_R" min="0" max="1" step="0.1" value="0.5">
    <button class="bigBtn" style="margin-top:5px; background:#5856d6;" onclick="window.playTestTone(1)">Saƒü Test üîä</button>
  </div>

  <button class="bigBtn" style="margin-top:20px; background:#ff9500;" onclick="window.prepareAndStart()">TESTƒ∞ BA≈ûLAT</button>
</div>

<div id="card_ci" class="card hidden">
  <h3>Dinleme Testi</h3>
  <div id="ci_info" style="text-align:center; padding:15px; background:#fffbe6; margin-bottom:15px; font-weight:bold;">Hazƒ±rlanƒ±yor...</div>
  <div class="respRow">
    <div class="respBtn" onclick="window.handleResponse('Left', this)">SOL</div>
    <div class="respBtn" onclick="window.handleResponse('Equal', this)">ORTA</div>
    <div class="respBtn" onclick="window.handleResponse('Right', this)">SAƒû</div>
  </div>
</div>

<div id="card_end" class="card hidden">
  <h3>Bitti!</h3>
  <p id="end_msg">G√∂nderiliyor...</p>
</div>

<script>
// --- GLOBAL DEƒûƒ∞≈ûKENLER VE AYARLAR ---
const FILE_LIST = ["LBA-RBA.wav", "LDA-RDA.wav", "LGA-RGA.wav", "LKA-RKA.wav", "LPA-RPA.wav", "LTA-RTA.wav"];
const FILE_PATH = "./sounds/yeni/erkek/"; 
const EMAIL_USER = "FLn2zMqKDGso3ePoO";

var DATA = { project:'', results:[] };
var audioCtx = null;
var audioBuffers = {};
var ciQueue = [];
var ciIndex = 0;
var allowClick = false;

// --- LOG FONKSƒ∞YONU ---
window.log = function(msg) {
  var d = document.getElementById('debugConsole');
  d.innerHTML = "> " + msg + "<br>" + d.innerHTML;
  console.log(msg);
}

window.onerror = function(msg, url, line) {
  window.log("HATA: " + msg + " (Satƒ±r:" + line + ")");
  alert("HATA: " + msg);
};

// --- SAYFA GE√áƒ∞≈ûLERƒ∞ ---
window.showCard = function(id) {
  document.querySelectorAll('.card').forEach(function(c){ c.classList.add('hidden'); });
  document.getElementById(id).classList.remove('hidden');
  window.unlockAudio(); // Her ge√ßi≈üte ses kilidini a√ßmayƒ± dene
}

window.nextStep = function(target) {
  if(target === 'card_participation') {
    var p = document.getElementById('projectCode').value;
    if(!p) { alert("Proje se√ßin!"); return; }
    DATA.project = p;
  }
  window.showCard(target);
}

window.saveInfo = function() {
  var n = document.getElementById('inp_name').value;
  var s = document.getElementById('inp_surname').value;
  var a = document.getElementById('inp_age').value;
  var e = document.getElementById('inp_email').value;
  
  if(!n || !s || !a) { alert("Ad, Soyad, Ya≈ü zorunlu."); return; }
  
  DATA.name = n; DATA.surname = s; DATA.age = a; DATA.email = e;
  DATA.code = DATA.project + "_" + Math.floor(Math.random()*9999);
  
  window.log("Kayƒ±t: " + DATA.code);
  // Diƒüer formlarƒ± atlayƒ±p direkt sese ge√ßiyoruz (Sadelik i√ßin)
  window.showCard('card_hearing');
}

// --- SES MOTORU ---
window.initAudio = function() {
  if(!audioCtx) {
    var AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if(audioCtx.state === 'suspended') { audioCtx.resume(); }
}

window.unlockAudio = function() {
  window.initAudio();
  // Bo≈ü ses √ßal (Safari Fix)
  var osc = audioCtx.createOscillator();
  var g = audioCtx.createGain();
  g.gain.value = 0.001; // √áok sessiz
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(0); osc.stop(0.01);
}

window.playTestTone = function(pan) {
  window.unlockAudio();
  var osc = audioCtx.createOscillator();
  var g = audioCtx.createGain();
  var panner = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : audioCtx.createPanner();
  
  osc.frequency.value = 1500;
  var vol = (pan===-1) ? document.getElementById('vol_L').value : document.getElementById('vol_R').value;
  g.gain.value = parseFloat(vol) * 0.1; // Bip sesi kƒ±sƒ±k olsun
  
  if(panner.pan) panner.pan.value = pan; else panner.setPosition(pan,0,0);
  
  osc.connect(g); g.connect(panner); panner.connect(audioCtx.destination);
  
  osc.start(); osc.stop(audioCtx.currentTime + 0.5);
  window.log("Test sesi √ßaldƒ±: " + pan);
}

// --- PRELOAD VE TEST BA≈ûLATMA ---
window.prepareAndStart = async function() {
  window.unlockAudio();
  
  if(DATA.project === 'CI') {
    document.getElementById('loadingOverlay').classList.remove('hidden');
    await window.loadSounds();
    document.getElementById('loadingOverlay').classList.add('hidden');
    window.startCITest();
  } else {
    // Standart test i√ßin de aynƒ± mantƒ±k eklenebilir
    alert("≈ûimdilik sadece CI testi aktif.");
  }
}

window.loadSounds = async function() {
  window.log("Sesler y√ºkleniyor...");
  var loaded = 0;
  for(var file of FILE_LIST) {
    try {
      var resp = await fetch(FILE_PATH + file);
      var buf = await resp.arrayBuffer();
      var ab = await audioCtx.decodeAudioData(buf);
      audioBuffers[file] = ab;
      loaded++;
      document.getElementById('loadingText').innerText = "%" + Math.round(loaded/FILE_LIST.length*100);
    } catch(e) {
      window.log("HATA Y√ºkleme: " + file);
    }
  }
}

// --- CI TEST ---
window.startCITest = function() {
  window.showCard('card_ci');
  
  // Kuyruk olu≈ütur
  ciQueue = [];
  var delays = [0, 0.003, 0.006, 0.009];
  
  // Tones
  delays.forEach(d => {
    ciQueue.push({type:'tone', delay:d, lead:'Left'});
    if(d>0) ciQueue.push({type:'tone', delay:d, lead:'Right'});
  });
  // Speech
  FILE_LIST.forEach(f => {
    delays.forEach(d => {
      ciQueue.push({type:'speech', file:f, delay:d, lead:'Left'});
      if(d>0) ciQueue.push({type:'speech', file:f, delay:d, lead:'Right'});
    });
  });
  
  // Karƒ±≈ütƒ±r
  ciQueue.sort(() => Math.random() - 0.5);
  
  ciIndex = 0;
  setTimeout(window.playNextCI, 1000);
}

window.playNextCI = function() {
  window.unlockAudio(); // HER SEFERƒ∞NDE
  
  if(ciIndex >= ciQueue.length) { window.finishExp(); return; }
  
  allowClick = false;
  var trial = ciQueue[ciIndex];
  
  document.getElementById('ci_info').innerText = "√áALINIYOR... (" + (ciIndex+1) + "/" + ciQueue.length + ")";
  
  if(trial.type === 'tone') window.playToneITD(trial);
  else window.playSpeechITD(trial);
  
  // 1 sn sonra butonlarƒ± a√ß
  setTimeout(() => {
    document.getElementById('ci_info').innerText = "YANITLAYIN";
    allowClick = true;
  }, 1000);
}

window.handleResponse = function(ans, btn) {
  if(!allowClick) return;
  
  // Efekt
  btn.style.background = "#007AFF"; btn.style.color = "#fff";
  setTimeout(()=> { btn.style.background = "#E5E5EA"; btn.style.color = "#333"; }, 200);
  
  // Kaydet
  var t = ciQueue[ciIndex];
  DATA.results.push({
    trial: ciIndex+1,
    type: t.type,
    stim: t.file || 'Tone',
    delay: t.delay,
    lead: t.lead,
    resp: ans
  });
  
  ciIndex++;
  setTimeout(window.playNextCI, 1500);
}

// --- OYNATMA FONKSƒ∞YONLARI ---
window.playToneITD = function(t) {
  var oscL = audioCtx.createOscillator(); oscL.frequency.value = 1500;
  var oscR = audioCtx.createOscillator(); oscR.frequency.value = 1500;
  
  var pL = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : audioCtx.createPanner();
  var pR = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : audioCtx.createPanner();
  
  if(pL.pan) { pL.pan.value = -1; pR.pan.value = 1; }
  else { pL.setPosition(-1,0,0); pR.setPosition(1,0,0); }
  
  var gL = audioCtx.createGain(); gL.gain.value = parseFloat(document.getElementById('vol_L').value) * 0.1;
  var gR = audioCtx.createGain(); gR.gain.value = parseFloat(document.getElementById('vol_R').value) * 0.1;
  
  oscL.connect(gL).connect(pL).connect(audioCtx.destination);
  oscR.connect(gR).connect(pR).connect(audioCtx.destination);
  
  var now = audioCtx.currentTime;
  var tL = now + 0.1;
  var tR = now + 0.1;
  
  if(t.lead === 'Left') tR += t.delay; else tL += t.delay;
  
  oscL.start(tL); oscL.stop(tL+0.5);
  oscR.start(tR); oscR.stop(tR+0.5);
}

window.playSpeechITD = function(t) {
  var buf = audioBuffers[t.file];
  if(!buf) { window.log("Ses yok: "+t.file); return; }
  
  var sL = audioCtx.createBufferSource();
  var sR = audioCtx.createBufferSource();
  
  var bL = audioCtx.createBuffer(1, buf.length, buf.sampleRate);
  var bR = audioCtx.createBuffer(1, buf.length, buf.sampleRate);
  
  bL.copyToChannel(buf.getChannelData(0), 0);
  bR.copyToChannel(buf.getChannelData(1), 0);
  
  sL.buffer = bL; sR.buffer = bR;
  
  var pL = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : audioCtx.createPanner();
  var pR = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : audioCtx.createPanner();
  
  if(pL.pan) { pL.pan.value = -1; pR.pan.value = 1; }
  else { pL.setPosition(-1,0,0); pR.setPosition(1,0,0); }
  
  var gL = audioCtx.createGain(); gL.gain.value = parseFloat(document.getElementById('vol_L').value);
  var gR = audioCtx.createGain(); gR.gain.value = parseFloat(document.getElementById('vol_R').value);
  
  sL.connect(gL).connect(pL).connect(audioCtx.destination);
  sR.connect(gR).connect(pR).connect(audioCtx.destination);
  
  var now = audioCtx.currentTime;
  var tL = now + 0.1;
  var tR = now + 0.1;
  
  if(t.lead === 'Left') tR += t.delay; else tL += t.delay;
  
  sL.start(tL); sR.start(tR);
}

// --- Bƒ∞Tƒ∞≈û ---
window.finishExp = function() {
  window.showCard('card_end');
  
  var csv = JSON.stringify(DATA);
  
  if(window.emailjs) {
    emailjs.init(EMAIL_USER);
    emailjs.send("service_a8bnfmk", "template_r6sddff", {
      subject: DATA.code,
      message: csv
    }).then(
      function() { document.getElementById('end_msg').innerText = "G√∂nderildi!"; },
      function(e) { document.getElementById('end_msg').innerText = "Hata: " + JSON.stringify(e); }
    );
  } else {
    alert("EmailJS y√ºklenemedi!");
  }
}

});
</script>
</body>
</html>
