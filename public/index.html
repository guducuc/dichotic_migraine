<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Dikotik & CI (Kanal Y√∂nlendirme Fix)</title>

<meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
<meta name="emailjs-service" content="service_a8bnfmk">
<meta name="emailjs-template" content="template_r6sddff">

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; margin:0; padding:15px; background:#f2f2f7; color:#1c1c1e; max-width: 600px; margin: auto; padding-bottom: 150px;}
  h1{font-size:1.3rem; text-align:center; margin-bottom:20px; color:#000;}
  .card{background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:20px; margin-bottom:20px;}
  .hidden{display:none !important;}
  
  input, select { width:100%; padding:14px; margin:8px 0; border:1px solid #d1d1d6; border-radius:10px; font-size:16px; box-sizing:border-box; }
  input[type="radio"] { width: 24px; height: 24px; margin-right: 12px; vertical-align: middle; }
  label { display: flex; align-items: center; margin-bottom: 14px; font-size: 16px; cursor:pointer; }
  
  .bigBtn { width:100%; padding:16px; border:none; border-radius:12px; background:#007AFF; color:white; font-size:17px; font-weight:600; cursor:pointer; margin-top:10px; transition: opacity 0.2s; }
  .bigBtn:active { opacity: 0.7; }
  .btnGreen { background:#34C759; } .btnRed { background:#FF3B30; }

  /* Debug Konsolu */
  #debugConsole { position:fixed; bottom:0; left:0; width:100%; height:120px; background:#1c1c1e; color:#30d158; font-family:monospace; font-size:11px; padding:10px; overflow-y:auto; z-index:9999; border-top:1px solid #333; }
  
  /* Ba≈ülatma Ekranƒ± */
  #startOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index: 3000; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; }

  /* Y√ºkleme Ekranƒ± */
  #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index: 2000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
  .loader { border: 4px solid #e5e5ea; border-top: 4px solid #007AFF; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  .respRow { display:flex; gap:10px; margin-top:15px; }
  .respBtn { flex:1; padding:20px 5px; background:#f2f2f7; border-radius:10px; text-align:center; font-weight:bold; cursor:pointer; border:1px solid #d1d1d6; color:#1c1c1e; user-select: none; }
  .respBtn:active, .respBtn-active { background:#007AFF !important; color:#fff !important; }
  
  #ciInfoDisplay { background: #e5e5ea; color: #1c1c1e; padding: 15px; text-align: center; border-radius: 10px; margin-bottom: 15px; font-weight: bold; }
  
  .modal{position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none; align-items:center; justify-content:center;}
  .modal-content{background:#fff; padding:25px; border-radius:16px; max-width:90%; max-height:80vh; overflow-y:auto; position:relative; width: 500px;}
  .close{position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer; color:#8e8e93;}
  
  /* Sonu√ß Tablosu */
  table.results-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
  table.results-table th, table.results-table td { border: 1px solid #d1d1d6; padding: 8px; text-align: center; }
  table.results-table th { background-color: #f2f2f7; font-weight: bold; }
  .res-correct { color: #34C759; font-weight: bold; }
  .res-wrong { color: #FF3B30; font-weight: bold; }
</style>
</head>
<body>

<h1>Dikotik & CI √áalƒ±≈ümasƒ±</h1>

<div id="debugConsole">Sistem Bekleniyor...<br></div>

<div id="startOverlay">
  <h2>Teste Ho≈ügeldiniz</h2>
  <p>Ses motorunu ba≈ülatmak i√ßin a≈üaƒüƒ±daki butona basƒ±nƒ±z.</p>
  <button class="bigBtn" style="width:auto; padding:20px 40px; margin-top:20px;" onclick="startAudioEngine()">Sƒ∞STEMƒ∞ BA≈ûLAT üîä</button>
</div>

<div id="loadingOverlay" class="hidden">
  <div class="loader"></div>
  <div style="font-weight:bold; font-size:18px;">Sesler Y√ºkleniyor...</div>
  <div id="loadingText" style="margin-top:10px; color:#8e8e93;">%0</div>
</div>

<div id="card_project" class="card hidden">
  <h3>Proje Kodu</h3>
  <select id="projectCode">
    <option value="">Se√ßiniz...</option>
    <option value="CI">CI (Zamanlama)</option>
    <option value="Esporcu">Esporcu</option>
    <option value="Sporcu">Sporcu</option>
    <option value="OCM">OCM</option>
    <option value="OykuTez">√ñyk√º Tez</option>
  </select>
  <button class="bigBtn" onclick="onProjectSelect()">Devam</button>
</div>

<div id="card_participation" class="card hidden">
  <h3>Katƒ±lƒ±m Durumu</h3>
  <label><input type="radio" name="partType" value="1" checked> ƒ∞lk kez katƒ±lƒ±yorum</label>
  <label><input type="radio" name="partType" value="2"> Daha √∂nce katƒ±ldƒ±m</label>
  <button class="bigBtn" onclick="showConsent()">Devam</button>
</div>

<div id="card_consent" class="card hidden">
  <h3>Onam Formu</h3>
  <button class="bigBtn" style="background:#8e8e93; margin-bottom:15px;" onclick="openModal()">Onam Formunu Oku</button>
  <div id="consentTextPreview" style="font-size:13px; color:#666; margin-bottom:15px;"></div>
  <div style="display:flex; gap:10px;">
    <button class="bigBtn btnGreen" onclick="show('card_info')">Kabul Ediyorum</button>
    <button class="bigBtn btnRed" onclick="alert('Reddedildi.')">Etmiyorum</button>
  </div>
</div>

<div id="consentModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <div id="modalBody"></div>
  </div>
</div>

<div id="card_info" class="card hidden">
  <h3>Ki≈üisel Bilgiler</h3>
  <input id="inp_name" placeholder="Ad (ƒ∞lk 2 harf)">
  <input id="inp_surname" placeholder="Soyad (ƒ∞lk 2 harf)">
  <input id="inp_age" type="number" placeholder="Ya≈ü">
  <input id="inp_email" type="email" placeholder="E-posta">
  <input id="inp_phone" type="tel" placeholder="Telefon">
  <input id="inp_race" placeholder="Doƒüum Yeri/Irk">
  <input id="inp_lang" placeholder="Anadil">
  <select id="inp_gender"><option value="">Cinsiyet</option><option>Kadƒ±n</option><option>Erkek</option><option>Diƒüer</option></select>
  <div id="codeDisplay" style="margin-top:10px; font-weight:bold; color:#007AFF;"></div>
  <button class="bigBtn" onclick="saveInfo()">Devam</button>
</div>

<div id="card_espor" class="card hidden">
  <h3>Esporcu Bilgileri</h3>
  <div class="question-group"><span class="question-title">Oyun T√ºr√º</span>
    <label><input type="radio" name="gameType" value="FPS"> FPS</label>
    <label><input type="radio" name="gameType" value="MOBA"> MOBA</label>
    <label><input type="radio" name="gameType" value="Diƒüer"> Diƒüer</label>
  </div>
  <input id="esp_years" type="number" placeholder="Ka√ß yƒ±ldƒ±r oynuyorsunuz?">
  <button class="bigBtn" onclick="saveExtra('espor')">Devam</button>
</div>

<div id="card_spor" class="card hidden">
  <h3>Sporcu Bilgileri</h3>
  <input id="sp_years" type="number" placeholder="Ka√ß yƒ±ldƒ±r spor yapƒ±yorsunuz?">
  <div class="question-group"><span class="question-title">Pozisyon</span>
    <label><input type="radio" name="pos" value="Guard"> Guard</label>
    <label><input type="radio" name="pos" value="Forvet"> Forvet</label>
    <label><input type="radio" name="pos" value="Pivot"> Pivot</label>
  </div>
  <button class="bigBtn" onclick="saveExtra('spor')">Devam</button>
</div>

<div id="card_hand" class="card hidden">
  <h3>El Kullanƒ±mƒ±</h3>
  <p style="font-size:14px; color:#666;">(Bu b√∂l√ºm ≈üu an pasiftir, devam ediniz.)</p>
  <button class="bigBtn" onclick="show('card_stai')">Devam</button>
</div>

<div id="card_stai" class="card hidden">
  <h3>Duygu Durumu</h3>
  <p style="font-size:14px; color:#666;">(Bu b√∂l√ºm ≈üu an pasiftir, devam ediniz.)</p>
  <button class="bigBtn" onclick="show('card_hearing')">Devam</button>
</div>

<div id="card_hearing" class="card hidden">
  <h3>Ses Kontrol√º</h3>
  <p style="color:#FF3B30; font-weight:bold; font-size:14px;">‚ö†Ô∏è iPhone/iPad: L√ºtfen yandaki "Sessiz" anahtarƒ±nƒ± kapatƒ±n.</p>
  <div style="background:#fff; padding:15px; border:1px solid #d1d1d6; border-radius:12px; margin-bottom:15px;">
    <label>Sol Kulak Sesi</label><input type="range" id="vol_L" min="0" max="1" step="0.1" value="0.5">
    <button class="bigBtn" style="background:#5856D6; margin-top:5px;" onclick="playTestTone(-1)">Sol Test (Bip) üîä</button>
  </div>
  <div style="background:#fff; padding:15px; border:1px solid #d1d1d6; border-radius:12px;">
    <label>Saƒü Kulak Sesi</label><input type="range" id="vol_R" min="0" max="1" step="0.1" value="0.5">
    <button class="bigBtn" style="background:#5856D6; margin-top:5px;" onclick="playTestTone(1)">Saƒü Test (Bip) üîä</button>
  </div>
  <button class="bigBtn" style="margin-top:25px; background:#FF9500;" onclick="startMainTest()">TESTƒ∞ BA≈ûLAT</button>
</div>

<div id="card_ci" class="card hidden">
  <h3>Zamanlama Testi (CI)</h3>
  <div id="ciInfoDisplay">Hazƒ±rlanƒ±yor...</div>
  <div style="text-align:center; font-weight:bold; margin-bottom:10px;">Sesi hangi tarafta duydunuz?</div>
  <div class="respRow">
    <div class="respBtn ciBtn" onclick="handleCIResponse('Left', this)">SOL</div>
    <div class="respBtn ciBtn" onclick="handleCIResponse('Equal', this)">ORTA / E≈ûƒ∞T</div>
    <div class="respBtn ciBtn" onclick="handleCIResponse('Right', this)">SAƒû</div>
  </div>
</div>

<div id="card_dicotic" class="card hidden">
  <h3>Dikotik Dinleme</h3>
  <div id="dicoticInfo" style="text-align:center; padding:10px; margin-bottom:10px;"></div>
  <button id="btn_startSession" class="bigBtn" onclick="startDicoticBlocks()">Ba≈üla</button>
  <div id="dicoticTrials" class="hidden" style="margin-top:20px;">
    <div class="respRow" style="flex-wrap:wrap;">
      <div class="respBtn dicoticBtn" onclick="handleDicoticResponse('BA', this)">BA</div>
      <div class="respBtn dicoticBtn" onclick="handleDicoticResponse('DA', this)">DA</div>
      <div class="respBtn dicoticBtn" onclick="handleDicoticResponse('GA', this)">GA</div>
      <div class="respBtn dicoticBtn" onclick="handleDicoticResponse('KA', this)">KA</div>
      <div class="respBtn dicoticBtn" onclick="handleDicoticResponse('PA', this)">PA</div>
      <div class="respBtn dicoticBtn" onclick="handleDicoticResponse('TA', this)">TA</div>
    </div>
  </div>
</div>

<div id="card_end" class="card hidden">
  <h3>Deney Tamamlandƒ± ‚úÖ</h3>
  <p id="endLog" style="color:green; font-weight:bold;">Veriler g√∂nderiliyor...</p>
  <div style="margin-top:20px;">
    <h4>Sonu√ßlarƒ±nƒ±z</h4>
    <div id="resultTableContainer" style="overflow-x:auto;"></div>
  </div>
</div>

<script>
// --- GLOBAL DEƒûƒ∞≈ûKENLER ---
let DATA = { project:'', results:[] };
let audioCtx = null;
let audioBuffers = {}; 
let ciQueue = [];
let ciIndex = 0;
let dicoticQueue = [];
let dicoticIndex = 0;
let isClickable = false;
let sessionOrder = [];
let currentSession = '';

// --- DOSYALAR ---
const ALL_FILES = ["LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav", "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav","LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav","LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav","LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav","LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav","LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav","LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav","LPA-RGA.wav"];
const UNIQUE_FILES = [...new Set(ALL_FILES)]; 
const PATH = "./sounds/yeni/erkek/"; 

// --- LOGLAMA ---
const logBox = document.getElementById('debugConsole');
function log(msg, type='info') {
    const time = new Date().toLocaleTimeString();
    const color = type === 'error' ? '#ff453a' : '#30d158';
    logBox.innerHTML = `<span style="color:${color}">[${time}] ${msg}</span><br>` + logBox.innerHTML;
}
window.onerror = function(msg, url, line) { log("JS HATASI: " + msg + " (" + line + ")", 'error'); };

// --- SES MOTORU (MERGER TEKNƒ∞ƒûƒ∞ - EN G√ú√áL√ú Y√ñNTEM) ---
function startAudioEngine() {
    try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if(!AC) return alert("Tarayƒ±cƒ±nƒ±z Web Audio API desteklemiyor!");
        
        audioCtx = new AC();
        audioCtx.resume().then(() => {
            log("Ses Motoru Ba≈üladƒ±! (State: " + audioCtx.state + ")");
            // Bo≈ü ses √ßal ve kanallarƒ± ƒ±sƒ±t
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            g.gain.value = 0.001;
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(0); osc.stop(0.1);
            
            // Ekran deƒüi≈ütir
            document.getElementById('startOverlay').classList.add('hidden');
            show('card_project');
        });
    } catch(e) { alert("Ses hatasƒ±: " + e.message); }
}

// Y√úKLEME
async function preloadAllSounds() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
    let loaded = 0;
    
    for (const filename of UNIQUE_FILES) {
        try {
            const response = await fetch(PATH + filename);
            const arrayBuffer = await response.arrayBuffer();
            const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            audioBuffers[filename] = audioBuffer;
            
            loaded++;
            document.getElementById('loadingText').innerText = "%" + Math.round((loaded/UNIQUE_FILES.length)*100);
        } catch (e) {
            log("Y√ºklenemedi: " + filename, 'error');
        }
    }
    document.getElementById('loadingOverlay').classList.add('hidden');
    log("T√ºm sesler y√ºklendi.");
}

// --- AKI≈û ---
function show(id) { 
    document.querySelectorAll('.card').forEach(c => c.classList.add('hidden')); 
    document.getElementById(id).classList.remove('hidden'); 
    window.scrollTo(0,0);
}
function nextStep(id) { show(id); }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

function onProjectSelect() {
    const p = document.getElementById('projectCode').value;
    if(!p) return alert("Se√ßiniz.");
    DATA.project = p;
    preloadAllSounds();
    show('card_participation');
}

function showConsent() {
    show('card_consent');
    let txt = "Bu √ßalƒ±≈üma bilimsel ama√ßlarla yapƒ±lmaktadƒ±r.";
    if(DATA.project === 'CI') txt = "CI Zamanlama √áalƒ±≈ümasƒ± Bilgilendirme...";
    document.getElementById('consentTextPreview').innerText = txt;
    document.getElementById('modalBody').innerHTML = txt;
}

function openModal() { document.getElementById('consentModal').style.display='flex'; }
function closeModal() { document.getElementById('consentModal').style.display='none'; }

function saveInfo() {
    const n = document.getElementById('inp_name').value.trim();
    if(!n) return alert("ƒ∞sim giriniz.");
    DATA.code = DATA.project + "_" + Math.floor(Math.random()*9999);
    document.getElementById('codeDisplay').innerText = "KOD: " + DATA.code;
    
    // Gerekli veri toplama (basitle≈ütirildi)
    DATA.name = n;
    
    if(DATA.project === 'Esporcu') show('card_espor');
    else if(DATA.project === 'Sporcu') show('card_spor');
    else show('card_hand'); 
}

function saveExtra(t) { show('card_hand'); }

// --- KANAL Bƒ∞RLE≈ûTƒ∞Rƒ∞Cƒ∞ (MERGER) ƒ∞LE OYNATMA (STEREO PANNER YERƒ∞NE) ---
function playSoundWithMerger(sourceNode, panVal) {
    // panVal: -1 (Sol), 1 (Saƒü), 0 (Orta)
    // Kaynak mono ise bunu sol ve saƒü kanallara manuel daƒüƒ±tacaƒüƒ±z
    
    const splitter = audioCtx.createChannelSplitter(2); // Gerekirse
    const merger = audioCtx.createChannelMerger(2); // 2 Kanallƒ± √ßƒ±kƒ±≈ü (L, R)
    const gainL = audioCtx.createGain();
    const gainR = audioCtx.createGain();
    
    // Ses Seviyelerini al
    const volL = parseFloat(document.getElementById('vol_L').value);
    const volR = parseFloat(document.getElementById('vol_R').value);
    
    // Pan Mantƒ±ƒüƒ± (Basit G√º√ß Daƒüƒ±lƒ±mƒ±)
    // Eƒüer Sol (-1) ise: Sol Gain = 1 * volL, Saƒü Gain = 0
    // Eƒüer Saƒü (1) ise: Sol Gain = 0, Saƒü Gain = 1 * volR
    
    let gL_val = (panVal === 1) ? 0 : 1; 
    let gR_val = (panVal === -1) ? 0 : 1;
    
    gainL.gain.value = gL_val * volL;
    gainR.gain.value = gR_val * volR;
    
    // Baƒülantƒ±: Source -> Gain -> Merger -> Destination
    // Tek kaynak olduƒüu i√ßin her iki gain'e de baƒülƒ±yoruz
    sourceNode.connect(gainL);
    sourceNode.connect(gainR);
    
    // Gain √ßƒ±kƒ±≈ülarƒ±nƒ± Merger'ƒ±n kanallarƒ±na baƒüla
    // Kanal 0 = Sol, Kanal 1 = Saƒü
    gainL.connect(merger, 0, 0); 
    gainR.connect(merger, 0, 1);
    
    merger.connect(audioCtx.destination);
    
    // Zaman logla
    log("√áalƒ±yor (T: " + audioCtx.currentTime.toFixed(2) + ")");
}

function playTestTone(pan) {
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    osc.frequency.value = 1500;
    
    playSoundWithMerger(osc, pan);
    
    osc.start(); 
    osc.stop(audioCtx.currentTime + 0.5);
}

function startMainTest() {
    DATA.volL = document.getElementById('vol_L').value;
    DATA.volR = document.getElementById('vol_R').value;
    if(DATA.project === 'CI') initCITest(); else { sessionOrder = ['training', 'NF', ...shuffle(['FR','FL'])]; startDicoticSession(); }
}

/* --- CI TEST --- */
function initCITest() {
    ciQueue = [];
    const delays = [0, 0.003, 0.006, 0.009];
    delays.forEach(d => { ciQueue.push({type:'tone', delay:d, lead:'Left'}); if(d>0) ciQueue.push({type:'tone', delay:d, lead:'Right'}); });
    ["LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav"].forEach(f => {
        delays.forEach(d => { ciQueue.push({type:'speech', file:f, delay:d, lead:'Left'}); if(d>0) ciQueue.push({type:'speech', file:f, delay:d, lead:'Right'}); });
    });
    ciQueue = shuffle(ciQueue);
    ciIndex = 0;
    show('card_ci');
    setTimeout(playNextCI, 1000);
}

function playNextCI() {
    if(ciIndex >= ciQueue.length) { finishExp(); return; }
    isClickable = false;
    const t = ciQueue[ciIndex];
    document.getElementById('ciInfoDisplay').innerHTML = `<strong>${t.type}</strong><br>Soru ${ciIndex+1}`;
    document.querySelectorAll('.ciBtn').forEach(b => b.style.opacity = 0.5);

    // ƒ∞ki ayrƒ± kaynak yaratƒ±p gecikmeli ba≈ülatacaƒüƒ±z (ITD i√ßin)
    const tL = audioCtx.currentTime + 0.1;
    let timeL = tL; 
    let timeR = tL;
    
    if(t.lead === 'Left') timeR += t.delay; else timeL += t.delay;
    
    // Sol Kaynak
    let srcL, srcR;
    
    if(t.type === 'tone') {
        srcL = audioCtx.createOscillator(); srcL.frequency.value = 1500;
        srcR = audioCtx.createOscillator(); srcR.frequency.value = 1500;
        srcL.start(timeL); srcL.stop(timeL+0.5);
        srcR.start(timeR); srcR.stop(timeR+0.5);
    } else {
        const buf = audioBuffers[t.file];
        srcL = audioCtx.createBufferSource(); srcL.buffer = buf;
        srcR = audioCtx.createBufferSource(); srcR.buffer = buf;
        srcL.start(timeL); 
        srcR.start(timeR);
    }
    
    // Merger ile manuel kanal atama
    const merger = audioCtx.createChannelMerger(2);
    const gL = audioCtx.createGain(); gL.gain.value = parseFloat(DATA.volL);
    const gR = audioCtx.createGain(); gR.gain.value = parseFloat(DATA.volR);
    
    srcL.connect(gL); gL.connect(merger, 0, 0); // Sol kaynak -> Sol Hoparl√∂r
    srcR.connect(gR); gR.connect(merger, 0, 1); // Saƒü kaynak -> Saƒü Hoparl√∂r
    
    merger.connect(audioCtx.destination);
    
    setTimeout(() => {
        document.querySelectorAll('.ciBtn').forEach(b => b.style.opacity = 1);
        isClickable = true;
    }, 1000);
}

function handleCIResponse(ans, btn) {
    if(!isClickable) return;
    const t = ciQueue[ciIndex];
    let correct = "Wrong";
    if(t.delay === 0 && ans === "Equal") correct = "Correct";
    else if(t.lead === ans) correct = "Correct";
    
    DATA.results.push({session:'CI_ITD', trial:ciIndex+1, type:t.type, stim:t.file||'Tone', delay:t.delay, lead:t.lead, resp:ans, isCorrect:correct});
    btn.style.background = '#007AFF'; setTimeout(()=>{ btn.style.background = '#f2f2f7'; }, 200);
    ciIndex++; setTimeout(playNextCI, 1500);
}

/* --- Dƒ∞KOTƒ∞K (STEREO DOSYA) --- */
function startDicoticBlocks() {
    document.getElementById('btn_startSession').classList.add('hidden');
    document.getElementById('dicoticTrials').classList.remove('hidden');
    if(currentSession === 'training') dicoticQueue = ["LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav"];
    else dicoticQueue = UNIQUE_FILES;
    dicoticIndex = 0; playNextDicotic();
}

function startDicoticSession() {
    if(sessionOrder.length === 0) { finishExp(); return; }
    currentSession = sessionOrder.shift();
    document.getElementById('dicoticInfo').innerText = "Oturum: " + currentSession;
    document.getElementById('btn_startSession').classList.remove('hidden');
    document.getElementById('dicoticTrials').classList.add('hidden');
    show('card_dicotic');
}

function playNextDicotic() {
    if(dicoticIndex >= dicoticQueue.length) { startDicoticSession(); return; }
    isClickable = false;
    document.getElementById('dicoticInfo').innerText = (dicoticIndex+1) + " / " + dicoticQueue.length;
    
    const file = dicoticQueue[dicoticIndex];
    const buffer = audioBuffers[file];
    
    if(buffer) {
        // Stereo dosyayƒ± olduƒüu gibi √ßal (ama vol√ºme dikkat et)
        const src = audioCtx.createBufferSource();
        src.buffer = buffer;
        
        // Basit gain
        const g = audioCtx.createGain();
        g.gain.value = parseFloat(DATA.volL); // Basitle≈ütirildi
        
        src.connect(g).connect(audioCtx.destination);
        src.start(0);
    }
    setTimeout(()=>{ isClickable = true; }, 500);
}

function handleDicoticResponse(val, btn) {
    if(!isClickable) return;
    const file = dicoticQueue[dicoticIndex];
    const match = file.includes(val) ? "Uyumlu" : "-";
    DATA.results.push({ session: currentSession, trial: dicoticIndex+1, stim:file, resp: val, isCorrect: match });
    btn.style.background = '#007AFF'; setTimeout(()=>{ btn.style.background = '#ecf0f1'; }, 200);
    dicoticIndex++; setTimeout(playNextDicotic, 1500);
}

/* --- Bƒ∞Tƒ∞≈û --- */
function finishExp() {
    show('card_end');
    let html = '<table class="results-table"><thead><tr><th>Soru</th><th>Detay</th><th>Yanƒ±t</th><th>Durum</th></tr></thead><tbody>';
    DATA.results.forEach(r => {
        let disp = r.isCorrect === "Correct" ? '<span class="res-correct">‚úÖ</span>' : (r.isCorrect === "Wrong" ? '<span class="res-wrong">‚ùå</span>' : r.isCorrect);
        let info = r.stim;
        if(r.lead) info += ` (${r.lead} +${r.delay*1000}ms)`;
        html += `<tr><td>${r.trial}</td><td>${info}</td><td>${r.resp}</td><td>${disp}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('resultTableContainer').innerHTML = html;

    const csv = JSON.stringify(DATA);
    if(window.emailjs) {
        emailjs.init("FLn2zMqKDGso3ePoO");
        emailjs.send("service_a8bnfmk", "template_r6sddff", { subject: DATA.code, message: csv })
        .then(()=> document.getElementById('endLog').innerText = "G√∂nderildi!", (e)=> document.getElementById('endLog').innerText = "Hata: " + JSON.stringify(e));
    }
}

});
</script>
</body>
</html>
