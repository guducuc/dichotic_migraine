<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Biyofizik Test BataryasÄ±</title>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; margin:0; padding:15px; background:#f2f2f7; color:#1c1c1e; max-width: 700px; margin: auto; padding-bottom: 120px;}
  h1{font-size:1.3rem; text-align:center; margin-bottom:20px; color:#000;}
  .card{background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:20px; margin-bottom:20px;}
  .hidden{display:none !important;}
  
  /* Form ElemanlarÄ± */
  input[type="text"], input[type="number"], input[type="email"], input[type="tel"], select { 
    width:100%; padding:12px; margin:8px 0; border:1px solid #d1d1d6; border-radius:8px; font-size:15px; box-sizing:border-box; background:#fff; 
  }
  input[type="radio"], input[type="checkbox"] { width: 18px; height: 18px; margin-right: 8px; vertical-align: middle; accent-color: #007AFF; }
  label { display: flex; align-items: center; margin-bottom: 8px; font-size: 15px; cursor:pointer; }
  
  /* Butonlar */
  .bigBtn { width:100%; padding:16px; border:none; border-radius:12px; background:#007AFF; color:white; font-size:16px; font-weight:600; cursor:pointer; margin-top:20px; transition: opacity 0.2s; }
  .bigBtn:active { opacity: 0.7; }
  .btnGreen { background:#34C759; } .btnRed { background:#FF3B30; } 

  /* Tablo Stilleri (El Tercihi) */
  .grid-table { width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
  .grid-table th { text-align:center; border-bottom:2px solid #ddd; padding:8px; background:#f9f9f9; }
  .grid-table td { border-bottom:1px solid #eee; padding:12px 5px; vertical-align:middle; }
  .grid-item-col { text-align: left; font-weight: 500; width: 40%; }
  .grid-check-col { text-align: center; }
  
  /* STAI DÃ¼zeni */
  .stai-row { border-bottom: 1px solid #eee; padding: 15px 0; }
  .stai-question { font-weight: 600; margin-bottom: 10px; display: block; }
  .stai-options { display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
  .stai-options label { font-weight: normal; font-size: 14px; background: #f9f9f9; padding: 8px 12px; border-radius: 6px; border: 1px solid #eee; flex: 1; justify-content: center; }
  
  /* CI ButonlarÄ± */
  .respRow { display:flex; gap:10px; margin-top:20px; }
  .respBtn { flex:1; padding:25px 5px; background:#f2f2f7; border-radius:12px; text-align:center; font-weight:bold; cursor:pointer; border:1px solid #d1d1d6; color:#1c1c1e; user-select: none; font-size:14px; opacity: 0.5; pointer-events: none; transition: all 0.2s; }
  .respBtn.active { opacity: 1; pointer-events: auto; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  
  /* YÃ¼kleme EkranÄ± */
  #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index: 2000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
  .loader { border: 4px solid #e5e5ea; border-top: 4px solid #007AFF; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* SonuÃ§ Tablosu */
  table.res-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
  table.res-table th, table.res-table td { border: 1px solid #ccc; padding: 5px; text-align: center; }
  .correct { color: green; font-weight: bold; }
  .wrong { color: red; font-weight: bold; }
  
  /* Debug Konsolu */
  #debugConsole { display:none; }
</style>
</head>
<body>

<h1>Biyofizik Test BataryasÄ±</h1>

<div id="startOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:3000; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; text-align:center;">
  <h2>HoÅŸgeldiniz</h2>
  <p>Test baÅŸlamadan Ã¶nce ses sistemini baÅŸlatmalÄ±yÄ±z.</p>
  <button class="bigBtn" style="width:auto; padding:15px 40px;" onclick="startAudioSystem()">BAÅLAT ğŸ”Š</button>
</div>

<div id="loadingOverlay" class="hidden">
  <div class="loader"></div>
  <div style="font-weight:bold; font-size:18px;">Sesler YÃ¼kleniyor...</div>
  <div id="loadingText" style="margin-top:10px; color:#8e8e93;">%0</div>
</div>

<div id="card_project" class="card hidden">
  <h3>Proje SeÃ§imi</h3>
  <select id="projectCode">
    <option value="">LÃ¼tfen seÃ§iniz...</option>
    <option value="Migren">Migren (Dikotik)</option>
    <option value="CI">CI</option>
  </select>
  <button class="bigBtn" onclick="onProjectSelect()">Devam Et</button>
</div>

<div id="card_participation" class="card hidden">
  <h3>KatÄ±lÄ±m Durumu</h3>
  <label><input type="radio" name="partType" value="1" checked> Ä°lk kez katÄ±lÄ±yorum</label>
  <label><input type="radio" name="partType" value="2"> Daha Ã¶nce katÄ±ldÄ±m</label>
  <button class="bigBtn" onclick="show('card_consent')">Devam Et</button>
</div>

<div id="card_consent" class="card hidden">
  <h3>AydÄ±nlatÄ±lmÄ±ÅŸ Onam</h3>
  <div id="consentTextPreview" style="height:150px; overflow-y:scroll; background:#f9f9f9; padding:10px; border:1px solid #eee; margin-bottom:15px; font-size:13px;"></div>
  <div style="display:flex; gap:10px;">
    <button class="bigBtn btnGreen" onclick="show('card_info')">OnaylÄ±yorum</button>
    <button class="bigBtn btnRed" onclick="alert('KatÄ±lÄ±m reddedildi.')">Red</button>
  </div>
</div>

<div id="card_info" class="card hidden">
  <h3>KatÄ±lÄ±mcÄ± Bilgileri</h3>
  <input id="inp_name" type="text" placeholder="Ad (Sadece ilk 2 harf)">
  <input id="inp_surname" type="text" placeholder="Soyad (Sadece ilk 2 harf)">
  <input id="inp_age" type="number" placeholder="YaÅŸ">
  <input id="inp_email" type="email" placeholder="E-posta">
  <input id="inp_phone" type="tel" placeholder="Telefon">
  <input id="inp_race" type="text" placeholder="DoÄŸum Yeri / Irk">
  <input id="inp_lang" type="text" placeholder="Anadil">
  <select id="inp_gender">
    <option value="">Cinsiyet SeÃ§iniz</option>
    <option value="KadÄ±n">KadÄ±n</option>
    <option value="Erkek">Erkek</option>
    <option value="DiÄŸer">DiÄŸer</option>
  </select>
  <select id="inp_edu">
    <option value="">EÄŸitim Durumu</option>
    <option value="Ä°lkÃ¶ÄŸretim">Ä°lkÃ¶ÄŸretim</option>
    <option value="Lise">Lise</option>
    <option value="Lisans">Lisans</option>
    <option value="YÃ¼ksek Lisans">YÃ¼ksek Lisans</option>
    <option value="Doktora">Doktora</option>
  </select>
  <div id="codeDisplay" style="margin-top:10px; font-weight:bold; color:#007AFF;"></div>
  <button class="bigBtn" onclick="saveInfo()">Devam Et</button>
</div>

<div id="card_hand" class="card hidden">
  <h3>El KullanÄ±m Tercihi</h3>
  <p style="font-size:13px; color:#666; line-height:1.4;">SaÄŸ veya sol elinizi hangi iÅŸlemlerde kullandÄ±ÄŸÄ±nÄ±zÄ± bilmek istiyoruz. LÃ¼tfen her iÅŸlemde kullandÄ±ÄŸÄ±nÄ±z ele gÃ¶re â€˜solâ€™ veya â€˜saÄŸâ€™ hanesini iÅŸaretleyin. Mesela yazÄ± yazarken, genellikle saÄŸ ama ara sÄ±ra sol elinizi kullanÄ±yorsanÄ±z, her iki elin altÄ±nda yalnÄ±zca birer kutucuÄŸu tÄ±klayÄ±n. Daima saÄŸ elinizi kullanÄ±yorsanÄ±z, saÄŸ el altÄ±ndaki iki kutucuÄŸu da iÅŸaretleyin. DiÄŸer sorularÄ± aynÄ± ÅŸekilde cevaplandÄ±rÄ±n. Her satÄ±rda mutlaka iki iÅŸaretleme olmalÄ±dÄ±r.</p>
  <table class="grid-table">
    <thead>
      <tr>
        <th style="text-align:left;">Ä°ÅŸlem</th>
        <th colspan="2">SOL</th>
        <th colspan="2">SAÄ</th>
      </tr>
    </thead>
    <tbody id="handTableBody"></tbody>
  </table>
  <button class="bigBtn" onclick="saveHandData()">Devam Et</button>
</div>

<div id="card_stai" class="card hidden">
  <h3>Duygu Durum Anketi (STAI-TX1)</h3>
  <p style="font-size:13px; color:#666;">AÅŸaÄŸÄ±da kiÅŸilerin kendilerine ait duygularÄ±nÄ± anlatmada kullandÄ±klarÄ± bir takÄ±m ifadeler verilmiÅŸtir. Her ifadeyi okuyun, sonra da nasÄ±l hissettiÄŸinizi ifadelerin saÄŸ tarafÄ±ndaki parantezlerden uygun olanÄ±nÄ± karalamak suretiyle belirtin. DoÄŸru ya da yanlÄ±ÅŸ cevap yoktur. Herhangi bir ifadenin Ã¼zerinde fazla zaman sarf etmeksizin anÄ±nda nasÄ±l hissettiÄŸinizi gÃ¶steren cevabÄ± iÅŸaretleyin.</p>
  <div id="staiContainer"></div> 
  <button class="bigBtn" onclick="show('card_hearing')">Devam Et</button>
</div>

<div id="card_hearing" class="card hidden">
  <h3>Ses KontrolÃ¼</h3>
  <p style="color:#FF3B30; font-weight:bold; font-size:14px; background:#fff0f0; padding:10px; border-radius:8px;">âš ï¸ iPhone/iPad: Yandaki "Sessiz" tuÅŸunu kapatÄ±n.</p>
  
  <div style="background:#fff; padding:15px; border:1px solid #d1d1d6; border-radius:12px; margin:15px 0;">
    <label><b>Sol Kulak</b> Seviyesi</label>
    <input type="range" id="vol_L" min="0" max="1" step="0.1" value="0.5">
    <button class="bigBtn" style="background:#5856D6; margin-top:5px; padding:10px;" onclick="playTestTone(-1)">Sol Bip ğŸ”Š</button>
  </div>

  <div style="background:#fff; padding:15px; border:1px solid #d1d1d6; border-radius:12px;">
    <label><b>SaÄŸ Kulak</b> Seviyesi</label>
    <input type="range" id="vol_R" min="0" max="1" step="0.1" value="0.5">
    <button class="bigBtn" style="background:#5856D6; margin-top:5px; padding:10px;" onclick="playTestTone(1)">SaÄŸ Bip ğŸ”Š</button>
  </div>

  <button class="bigBtn" style="margin-top:30px; background:#FF9500;" onclick="startExperiment()">TESTÄ° BAÅLAT</button>
</div>

<div id="card_ci" class="card hidden">
  <h3 id="ci_stage_title">Dinleme Testi</h3>
  <div style="background:#e5e5ea; padding:20px; border-radius:10px; text-align:center; font-weight:bold; font-size:18px; color:#1c1c1e; margin-bottom:20px;" id="ci_stim_info">HazÄ±r...</div>
  <p style="text-align:center;">Sesi hangi yÃ¶nden duydunuz?</p>
  <div class="respRow">
    <div class="respBtn ciBtn" onclick="handleCIResponse('Left', this)">SOL</div>
    <div class="respBtn ciBtn" onclick="handleCIResponse('Equal', this)">ORTA</div>
    <div class="respBtn ciBtn" onclick="handleCIResponse('Right', this)">SAÄ</div>
  </div>
</div>

<div id="card_dicotic" class="card hidden">
  <h3>Dikotik Dinleme</h3>
  <div id="dicoticInfo" style="text-align:center; padding:10px; margin-bottom:10px; font-weight:bold; background:#e1f5fe; border-radius:8px;"></div>
  
  <div id="dicoticStartBtnArea" style="text-align:center; margin-top:20px;">
    <p id="dicoticInstruction" style="margin-bottom:15px;">Bu aÅŸamada...</p>
    <button class="bigBtn" onclick="startDicoticBlock()">BaÅŸla</button>
  </div>

  <div id="dicoticTrials" class="hidden" style="margin-top:20px;">
    <div class="respRow" style="flex-wrap:wrap;">
      <div class="respBtn dicoticBtn" onclick="handleDicoticResponse('BA', this)">BA</div>
      <div class="respBtn dicoticBtn" onclick="handleDicoticResponse('DA', this)">DA</div>
      <div class="respBtn dicoticBtn" onclick="handleDicoticResponse('GA', this)">GA</div>
      <div class="respBtn dicoticBtn" onclick="handleDicoticResponse('KA', this)">KA</div>
      <div class="respBtn dicoticBtn" onclick="handleDicoticResponse('PA', this)">PA</div>
      <div class="respBtn dicoticBtn" onclick="handleDicoticResponse('TA', this)">TA</div>
    </div>
  </div>
</div>

<div id="card_end" class="card hidden">
  <h3>Test TamamlandÄ± âœ…</h3>
  <p>Verileriniz iÅŸleniyor...</p>
  <div id="endLog" style="color:#34C759; font-weight:bold; margin-bottom:20px;"></div>
  
  <div style="margin-top:20px; overflow-x:auto;">
    <h4>SonuÃ§ Ã–nizleme</h4>
    <div id="resultTableContainer"></div>
  </div>
</div>

<script>
/* --- 1. GLOBAL AYARLAR --- */
const EMAIL_CONFIG = { userID: "FLn2zMqKDGso3ePoO", serviceID: "service_a8bnfmk", templateID: "template_7elc4wi" };

// Global Veri
let DATA = { project: '', results: [] };
let audioCtx = null;
let audioBuffers = {}; 
let ciQueue = []; let ciIndex = 0;
let dicoticQueue = []; let dicoticIndex = 0;
let sessionOrder = []; let currentSession = '';
let responseTimer = null; 
let isClickable = false;

// Dosyalar
const SYLLABLES = ["LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav"];
const DICOTIC_MAIN = ["LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav","LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav","LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav","LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav","LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav","LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav","LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav","LPA-RGA.wav"];
const DICOTIC_TRAIN = ["LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav"];
const ALL_FILES = [...new Set([...SYLLABLES, ...DICOTIC_MAIN, ...DICOTIC_TRAIN])];
const PATH = "./sounds/yeni/erkek/"; 

// Hata Yakalama
window.onerror = (msg, url, line) => console.error("ERR: " + msg);

/* --- 2. SES MOTORU --- */
function startAudioSystem() {
    try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return alert("TarayÄ±cÄ±nÄ±z desteklenmiyor.");
        
        audioCtx = new AC();
        audioCtx.resume().then(() => {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            g.gain.value = 0.001;
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(0); osc.stop(0.1);
            
            document.getElementById('startOverlay').classList.add('hidden');
            show('card_project');
        });
    } catch(e) { alert("Ses hatasÄ±: " + e); }
}

function kickAudio() {
    if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
}
document.addEventListener('click', kickAudio);
document.addEventListener('touchstart', kickAudio);

// Ses DosyalarÄ±nÄ± YÃ¼kle
async function preloadAllSounds() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
    let loaded = 0;
    const uniqueFiles = [...new Set(ALL_FILES)]; 
    
    for (let f of uniqueFiles) {
        try {
            const url = PATH + f + "?v=" + Math.floor(Math.random() * 99999);
            const resp = await fetch(url);
            const buf = await resp.arrayBuffer();
            audioBuffers[f] = await audioCtx.decodeAudioData(buf);
            
            loaded++;
            document.getElementById('loadingText').innerText = "%" + Math.round((loaded/uniqueFiles.length)*100);
        } catch(e) {
            console.error("YÃ¼kleme hatasÄ±: " + f);
        }
    }
    document.getElementById('loadingOverlay').classList.add('hidden');
}

/* --- 3. AKIÅ YÃ–NETÄ°MÄ° --- */
function show(id) {
    document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo(0,0);
}

function onProjectSelect() {
    const p = document.getElementById('projectCode').value;
    if(!p) return alert("Proje seÃ§iniz.");
    DATA.project = p;
    preloadAllSounds();
    show('card_participation');
}

function saveInfo() {
    const n = document.getElementById('inp_name').value.trim();
    const s = document.getElementById('inp_surname').value.trim();
    if(!n || !s) return alert("Ad ve Soyad zorunludur.");
    
    DATA.name = n; 
    DATA.surname = s;
    DATA.age = document.getElementById('inp_age').value;
    DATA.email = document.getElementById('inp_email').value;
    DATA.phone = document.getElementById('inp_phone').value;
    DATA.race = document.getElementById('inp_race').value;
    DATA.lang = document.getElementById('inp_lang').value;
    DATA.gender = document.getElementById('inp_gender').value;
    DATA.edu = document.getElementById('inp_edu').value;
    
    DATA.code = DATA.project + "_" + Math.floor(1000 + Math.random()*9000);
    document.getElementById('codeDisplay').innerText = "KODUNUZ: " + DATA.code;
    
    renderHandTable();
    show('card_hand');
}

/* --- 4. Ã–LÃ‡EKLER (EL & STAI) --- */
const HAND_ITEMS = ["Yazmak","Ã‡izmek","TaÅŸ Atmak","Makas kullanmak","DiÅŸ fÄ±rÃ§asÄ±","BÄ±Ã§ak (Peynir keserken vb.)","KaÅŸÄ±k","SÃ¼pÃ¼rge (Ã¼stteki el)","Kibrit Ã§akmak (Ã§akan el)","Kutu kapaÄŸÄ± aÃ§mak (tutan el)"];

function renderHandTable() {
    const tbody = document.getElementById('handTableBody');
    tbody.innerHTML = "";
    HAND_ITEMS.forEach((item, i) => {
        tbody.innerHTML += `
        <tr>
            <td class="grid-item-col">${item}</td>
            <td class="grid-check-col"><input type="checkbox" name="h_${i}_L1"> <input type="checkbox" name="h_${i}_L2"></td>
            <td class="grid-check-col"><input type="checkbox" name="h_${i}_R1"> <input type="checkbox" name="h_${i}_R2"></td>
        </tr>`;
    });
}

function saveHandData() {
    // El Verilerini Kaydet
    let handRes = [];
    HAND_ITEMS.forEach((it, i) => {
        let l1 = document.querySelector(`input[name="h_${i}_L1"]`).checked ? 1 : 0;
        let l2 = document.querySelector(`input[name="h_${i}_L2"]`).checked ? 1 : 0;
        let r1 = document.querySelector(`input[name="h_${i}_R1"]`).checked ? 1 : 0;
        let r2 = document.querySelector(`input[name="h_${i}_R2"]`).checked ? 1 : 0;
        handRes.push({item: it, L: l1+l2, R: r1+r2});
    });
    DATA.handData = handRes; // Veriye ekle

    renderStai();
    show('card_stai');
}

function renderStai() {
    const div = document.getElementById('staiContainer');
    div.innerHTML = ""; 
    const questions = ["Åu anda sakinim","Kendimi emniyette hissediyorum","Åu anda sinirlerim gergin","PiÅŸmanlÄ±k duygusu iÃ§indeyim","Åu anda huzur iÃ§indeyim","Åu anda hiÃ§ keyfim yok","BaÅŸÄ±ma geleceklerden endiÅŸe ediyorum","Kendimi dinlenmiÅŸ hissediyorum","Åu anda kaygÄ±lÄ±yÄ±m","Kendimi rahat hissediyorum","Kendime gÃ¼venim var","Åu anda asabÄ±m bozuk","Ã‡ok sinirliyim","Sinirlerimin Ã§ok gergin olduÄŸunu hissediyorum","Kendimi rahatlamÄ±ÅŸ hissediyorum","Åu anda halimden memnunum","Åu anda endiÅŸeliyim","Heyecandan kendimi ÅŸaÅŸkÄ±na dÃ¶nmÃ¼ÅŸ hissediyorum","Åu anda sevinÃ§liyim","Åu anda keyfim yerinde"]; 
    
    questions.forEach((q, i) => {
        div.innerHTML += `
        <div class="stai-row">
            <span class="stai-question">${i+1}. ${q}</span>
            <div class="stai-options">
                <label><input type="radio" name="s${i}" value="1"> HiÃ§</label>
                <label><input type="radio" name="s${i}" value="2"> Biraz</label>
                <label><input type="radio" name="s${i}" value="3"> Ã‡ok</label>
                <label><input type="radio" name="s${i}" value="4"> TamamÄ±yla</label>
            </div>
        </div>`;
    });
}

// Ä°ÅÄ°TME
function playTestTone(pan) {
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator(); osc.frequency.value = 1500;
    const merger = audioCtx.createChannelMerger(2);
    const gL = audioCtx.createGain(); const gR = audioCtx.createGain();
    const vL = parseFloat(document.getElementById('vol_L').value) * 0.1;
    const vR = parseFloat(document.getElementById('vol_R').value) * 0.1;
    gL.gain.value = (pan===-1) ? vL : 0;
    gR.gain.value = (pan===1) ? vR : 0;
    osc.connect(gL); osc.connect(gR);
    gL.connect(merger, 0, 0); gR.connect(merger, 0, 1);
    merger.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + 0.5);
}

function startExperiment() {
    // STAI Verilerini Kaydet
    let staiRes = {};
    for(let i=0; i<20; i++) {
        let el = document.querySelector(`input[name="s${i}"]:checked`);
        staiRes[`Q${i+1}`] = el ? el.value : 0;
    }
    DATA.staiData = staiRes;

    DATA.volL = document.getElementById('vol_L').value;
    DATA.volR = document.getElementById('vol_R').value;
    
    if(DATA.project === 'CI') {
        initCITest();
    } else if(DATA.project === 'Migren') {
        sessionOrder = ['Training', 'NF', ...pseudoShuffle(['FR','FL'])];
        startDicoticSession();
    }
}

/* --- 6. CI TEST --- */
function pseudoShuffle(arr, key) {
    if(!key) { 
        for(let i=arr.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
        return arr;
    }
    for(let i=arr.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    for(let i=1; i<arr.length; i++) {
        if(arr[i][key] === arr[i-1][key]) {
            for(let j=i+1; j<arr.length; j++) {
                if(arr[j][key] !== arr[i-1][key]) { [arr[i],arr[j]]=[arr[j],arr[i]]; break; }
            }
        }
    }
    return arr;
}

function initCITest() {
    ciQueue = [];
    const delays = [0, 0.003, 0.006, 0.009];
    
    let tones = [];
    [1000, 1500, 2000].forEach(fr => {
        delays.forEach(d => {
            tones.push({type:'tone', freq:fr, delay:d, lead:'Left'});
            if(d>0) tones.push({type:'tone', freq:fr, delay:d, lead:'Right'});
        });
    });
    tones = pseudoShuffle(tones, 'freq');
    
    let syls = [];
    SYLLABLES.forEach(f => {
        delays.forEach(d => {
            syls.push({type:'speech', file:f, delay:d, lead:'Left'});
            if(d>0) syls.push({type:'speech', file:f, delay:d, lead:'Right'});
        });
    });
    syls = pseudoShuffle(syls, 'file');
    
    ciQueue = [...tones, ...syls];
    ciIndex = 0;
    show('card_ci');
    setTimeout(playNextCI, 1000);
}

function playNextCI() {
    clearTimeout(responseTimer);
    if(ciIndex >= ciQueue.length) { finishExp(); return; }
    
    isClickable = false;
    const t = ciQueue[ciIndex];
    document.getElementById('ci_stage_title').innerText = t.type==='tone' ? "BÃ–LÃœM 1: SAF SESLER" : "BÃ–LÃœM 2: HECELER";
    document.getElementById('ci_stim_info').innerText = "Ã‡ALINIYOR...";
    document.querySelectorAll('.ciBtn').forEach(b => b.classList.remove('active'));

    let duration = 0.5;
    if(t.type === 'speech' && audioBuffers[t.file]) duration = audioBuffers[t.file].duration;

    if(t.type === 'tone') playToneITD(t); else playSpeechITD(t);
    
    const lockTime = (duration * 1000) + 300;
    setTimeout(() => {
        document.getElementById('ci_stim_info').innerText = "YANITLAYINIZ";
        document.querySelectorAll('.ciBtn').forEach(b => b.classList.add('active'));
        isClickable = true;
        
        responseTimer = setTimeout(() => { handleCIResponse("No Response", null, true); }, 4000);
    }, lockTime);
}

function playToneITD(t) {
    const merger = audioCtx.createChannelMerger(2);
    const gL = audioCtx.createGain(); gL.gain.value = parseFloat(DATA.volL) * 0.1;
    const gR = audioCtx.createGain(); gR.gain.value = parseFloat(DATA.volR) * 0.1;
    const tStart = audioCtx.currentTime + 0.1;
    let tL = tStart, tR = tStart;
    if(t.lead === 'Left') tR += t.delay; else tL += t.delay;
    const oscL = audioCtx.createOscillator(); oscL.frequency.value = t.freq;
    const oscR = audioCtx.createOscillator(); oscR.frequency.value = t.freq;
    oscL.connect(gL); gL.connect(merger, 0, 0);
    oscR.connect(gR); gR.connect(merger, 0, 1);
    merger.connect(audioCtx.destination);
    oscL.start(tL); oscL.stop(tL+0.5);
    oscR.start(tR); oscR.stop(tR+0.5);
}

function playSpeechITD(t) {
    const buf = audioBuffers[t.file];
    if(!buf) return;
    const merger = audioCtx.createChannelMerger(2);
    const gL = audioCtx.createGain(); gL.gain.value = parseFloat(DATA.volL);
    const gR = audioCtx.createGain(); gR.gain.value = parseFloat(DATA.volR);
    const sL = audioCtx.createBufferSource(); sL.buffer = buf;
    const sR = audioCtx.createBufferSource(); sR.buffer = buf;
    const tStart = audioCtx.currentTime + 0.1;
    let tL = tStart, tR = tStart;
    if(t.lead === 'Left') tR += t.delay; else tL += t.delay;
    sL.connect(gL); gL.connect(merger, 0, 0);
    sR.connect(gR); gR.connect(merger, 0, 1);
    merger.connect(audioCtx.destination);
    sL.start(tL); sR.start(tR);
}

function handleCIResponse(ans, btn, isTimeout=false) {
    if(!isClickable && !isTimeout) return;
    clearTimeout(responseTimer);
    isClickable = false;
    document.querySelectorAll('.ciBtn').forEach(b => b.classList.remove('active'));

    const t = ciQueue[ciIndex];
    let correct = "Wrong";
    if(isTimeout) { ans = "No Response"; } 
    else {
        if(t.delay === 0 && ans === "Equal") correct = "Correct";
        else if(t.lead === ans) correct = "Correct";
        if(btn) {
            btn.style.background = '#007AFF'; btn.style.color = '#fff';
            setTimeout(()=>{ btn.style.background = '#f2f2f7'; btn.style.color = '#1c1c1e'; }, 200);
        }
    }
    
    DATA.results.push({trial:ciIndex+1, section:'CI', type:t.type, stim:t.freq||t.file, delay:t.delay, lead:t.lead, resp:ans, isCorrect:correct});
    ciIndex++; 
    setTimeout(playNextCI, Math.floor(Math.random() * 500) + 2000);
}

/* --- DÄ°KOTÄ°K (MÄ°GREN) --- */
function startDicoticSession() {
    if(sessionOrder.length === 0) { finishExp(); return; }
    currentSession = sessionOrder.shift();
    let instr = "";
    if(currentSession === 'Training') instr = "EÄŸitim BÃ¶lÃ¼mÃ¼: DuyduÄŸunuzu seÃ§in.";
    if(currentSession === 'NF') instr = "Serbest Dinleme (NF): En net duyduÄŸunuzu seÃ§in.";
    if(currentSession === 'FR') instr = "SaÄŸ OdaklÄ± (FR): Sadece SAÄ kulaÄŸÄ±nÄ±za odaklanÄ±n.";
    if(currentSession === 'FL') instr = "Sol OdaklÄ± (FL): Sadece SOL kulaÄŸÄ±nÄ±za odaklanÄ±n.";
    document.getElementById('dicoticInfo').innerText = instr;
    document.getElementById('dicoticInstruction').innerText = "HazÄ±r olduÄŸunuzda BaÅŸla butonuna basÄ±n.";
    document.getElementById('dicoticStartBtnArea').classList.remove('hidden');
    document.getElementById('dicoticTrials').classList.add('hidden');
    show('card_dicotic');
}

function startDicoticBlock() {
    document.getElementById('dicoticStartBtnArea').classList.add('hidden');
    document.getElementById('dicoticTrials').classList.remove('hidden');
    if(currentSession === 'Training') dicoticQueue = DICOTIC_TRAIN;
    else dicoticQueue = DICOTIC_MAIN;
    dicoticIndex = 0; playNextDicotic();
}

function playNextDicotic() {
    if(dicoticIndex >= dicoticQueue.length) { startDicoticSession(); return; }
    isClickable = false;
    const file = dicoticQueue[dicoticIndex];
    const buf = audioBuffers[file];
    if(buf) {
        const src = audioCtx.createBufferSource();
        src.buffer = buf;
        const g = audioCtx.createGain();
        g.gain.value = (parseFloat(DATA.volL) + parseFloat(DATA.volR)) / 2;
        src.connect(g).connect(audioCtx.destination);
        src.start(0);
    }
    setTimeout(()=>{ isClickable = true; }, 500);
}

function handleDicoticResponse(val, btn) {
    if(!isClickable) return;
    const file = dicoticQueue[dicoticIndex];
    const match = file.includes(val) ? "Uyumlu" : "-";
    DATA.results.push({ session: currentSession, trial: dicoticIndex+1, stim:file, resp: val, isCorrect: match });
    btn.style.background = '#007AFF'; btn.style.color = '#fff';
    setTimeout(()=>{ btn.style.background = '#f2f2f7'; btn.style.color = '#1c1c1e'; }, 200);
    dicoticIndex++; setTimeout(playNextDicotic, 1500);
}

/* --- BÄ°TÄ°Å --- */
function finishExp() {
    show('card_end');
    
    // 1. CSV METNÄ° OLUÅTUR
    const csvContent = generateCSV(DATA.results);
    
    // 2. TABLO GÃ–STER
    let html = '<table class="res-table"><thead><tr><th>Soru</th><th>Uyaran</th><th>YanÄ±t</th><th>D</th></tr></thead><tbody>';
    DATA.results.forEach(r => {
        let cls = r.isCorrect === "Correct" ? "correct" : (r.isCorrect === "Wrong" ? "wrong" : "");
        let d = r.isCorrect === "Correct" ? "âœ”" : (r.isCorrect === "Wrong" ? "âœ–" : r.isCorrect);
        html += `<tr><td>${r.trial}</td><td>${r.stim}</td><td>${r.resp}</td><td class="${cls}">${d}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('resultTableContainer').innerHTML = html;
    
    // 3. E-POSTA Ä°Ã‡ERÄ°ÄÄ° HAZIRLA (CSV Dahil)
    const emailBody = `
KOD: ${DATA.code}
AD SOYAD: ${DATA.name} ${DATA.surname}
YAÅ: ${DATA.age} | CÄ°NSÄ°YET: ${DATA.gender} | EÄÄ°TÄ°M: ${DATA.edu}
--------------------------------------------------
EL TERCÄ°HÄ° VERÄ°SÄ° (JSON):
${JSON.stringify(DATA.handData)}
--------------------------------------------------
STAI VERÄ°SÄ° (JSON):
${JSON.stringify(DATA.staiData)}
--------------------------------------------------
SONUÃ‡LAR (CSV FORMATI - KOPYALA YAPIÅTIR YAPINIZ):
--------------------------------------------------
${csvContent}
    `;

    if(window.emailjs) {
        emailjs.init(EMAIL_CONFIG.userID);
        emailjs.send(EMAIL_CONFIG.serviceID, EMAIL_CONFIG.templateID, { 
            subject: "SONUC: " + DATA.code, 
            message: emailBody 
        })
        .then(()=> document.getElementById('endLog').innerText = "Veriler E-posta ile GÃ¶nderildi!", 
              (e)=> document.getElementById('endLog').innerText = "Hata: " + JSON.stringify(e));
    }
}

// CSV ÃœRETÄ°CÄ°
function generateCSV(results) {
    if(!results || results.length === 0) return "Veri Yok";
    const headers = Object.keys(results[0]).join(",");
    const rows = results.map(row => Object.values(row).join(","));
    return [headers, ...rows].join("\n");
}
</script>
</body>
</html>
